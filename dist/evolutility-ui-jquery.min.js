/*!
   evolutility-ui-jquery 1.2.2 
   (c) 2017 Olivier Giulieri 
   http://evoluteur.github.io/evolutility-ui-jquery/  
*/
var Evol=Evol||{};Evol.Config={localStorage:!1,url:"http://localhost:5000/ce/api/v1.0/"};var Evol=Evol||{};Evol.i18n={LOCALE:"EN",getLabel:function(a,b,c){var d;if(a.indexOf(".")>-1){var e=a.split(".");d=this[e[0]][e[1]]}else d=this[a];return b&&d&&(d=d.replace("{0}",b),c&&(d=d.replace("{1}",c))),d},tools:{View:"View",bBrowse:"Browse",bEdit:"Edit",bMini:"Mini",bNew:"New",newEntity:"New {0}",bExport:"Export",bImport:"Import",bDelete:"Delete",bList:"List",bCards:"Cards",bJSON:"JSON",bFilter:"Filter",bBubbles:"Bubbles",bCharts:"Charts",bSave:"Save",bSaveAdd:"Save and Add Another",bOK:"OK",bCancel:"Cancel",vizGroupBy:"Group by",vizColorBy:"Color by",vizSizeBy:"Size by",prev:"Previous",next:"Next",finish:"Finish !"},saved:"{0} saved.",unSavedTitle:"Changes pending",unSavedChanges:'Do you want to save the changes you made to "{0}"?',warnNoSave:"Your changes will be lost if you don't save them.",bNoSave:"Don't Save",deleteX:"Delete {0}",delete1:'Do you really want to delete the {0} "{1}"?',deleteN:"Delete {0} {1}?",deleted1:"{0} deleted.",notFound:"Item not found.",notFoundMsg:"No {0} found.",notFoundMsgId:'No {0} found for ID="{1}".',yes:"Yes",no:"No",none:"None",na:"N/A",nodata:"No data available.",notEnoughdata:"Not enough data available.",nopix:"No picture.",nochart:"No charts available.",badchart:"Not enough information provided to draw charts.",range:"{0} - {1} of {2} {3}",selected:"{0} selected",msg:{sgn_money:"$",sgn_email:"@",added:'New {0} "{1}" added.',updated:'{0} "{1}" updated.',deleted:'{0} "{1}" deleted.'},validation:{incomplete:"Some information is missing or invalid.",invalid:"Invalid format.",invalidList:'{0} values in "{1}" are invalid.',invalidList1:'1 value in "{1}" is invalid.',empty:'"{0}" must have a value.',email:'"{0}" must be a valid email formatted like "name@domain.com".',integer:'"{0}" must only use numbers.',decimal:'"{0}" must be a valid decimal numbers.',money:'"{0}" must be a valid number.',date:'"{0}" must be a valid date, format must be "MM/DD/YYYY" like "12/24/2015".',datetime:'"{0}" must be a valid date/time, format must be "MM/DD/YYYY hh:mm AM/PM" like "12/24/2015 10:30 AM".',time:'"{0}" must be a valid date/time, format must be "hh:mm AM/PM" like "10:30 AM".',json:'"{0}" must be a valid JSON expression like "{"a": 1}".',max:'"{0}" must be smaller or equal to {1}.',min:'"{0}" must be greater or equal to {1}.',maxLength:'"{0}" must be {1} characters long maximum.',minLength:'"{0}" must be at least {1} characters long.',minMaxLength:'"{0}" must be between {1} and {2} characters long.',regExp:'"{0}" is not of the expected format.'},charts:{aByB:"{0} by {1}",aB:"{0}: {1}"},export:{exportOne:"Export {0}",exportMany:"Export {0}",preview:"Export preview",header:"Header",options:"options",separator:"Separator",firstLine:"The first row is a header",format:"Export format",xpFields:"Fields to include in the export",IDkey:"ID",allFields:"Show all fields",formatCSV:"Comma separated values (CSV, TXT, XLS...)",formatHTML:"HTML",formatSQL:"SQL Insert Statements (SQL)",formatTAB:"Tab separated values (TXT)",formatXML:"XML",formatJSON:"Javascript Object Notation (JSON)",XMLroot:"Element name",headerLabels:"Field Labels",headerIds:"Field Attributes or Ids",db:"Database",SQL:"SQL Options",SQLTable:"Table name",SQLTrans:"In transaction",SQLIdInsert:"Identity insert",DownloadEntity:"Download {0}"},import:{importOne:"Import {0}",importMany:"Import {0}",format:"Source Format",fSample:"Sample",allowDups:"Allow duplicates",data:"Data to Import",success:"Import done.",empty:"Nothing to Import."},filters:{sEqual:"equals",sNotEqual:"not equal",sStart:"starts with",sContain:"contains",sNotContain:"doesn't contain",sFinish:"finishes with",sInList:"is any of",sIsNull:"is empty",sIsNotNull:"is not empty",sBefore:"before",sAfter:"after",sNumEqual:"&#61;",sNumNotEqual:"!&#61;",sGreater:"&#62;",sSmaller:"&#60;",sOn:"on",sNotOn:"not on",sAt:"at",sNotAt:"not at",sBetween:"between",opAnd:"and",yes:"Yes",no:"No",bNewCond:"New filter condition",bAddCond:"Add condition",bUpdateFilter:"Update filter",bSubmit:"Submit",bCancel:"Cancel"}};var Evol=Evol||{};Evol.Def=function(){var a={text:"text",textml:"textmultiline",bool:"boolean",int:"integer",dec:"decimal",money:"money",date:"date",datetime:"datetime",time:"time",lov:"lov",list:"list",html:"html",formula:"formula",email:"email",pix:"image",url:"url",color:"color",hidden:"hidden",json:"json"};return{fieldTypes:a,isViewMany:function(a){return this.isViewCollection(a)||this.isViewCharts(a)},isViewCollection:function(a){return"list"===a||"cards"===a},isViewCharts:function(a){return"charts"===a||"bubbles"===a||"scatter"===a||"sunburst"===a},fieldInCharts:function(a){return(_.isUndefined(a.inCharts)||a.inCharts)&&Evol.Def.fieldChartable(a)},fieldChartable:function(b){return b.type===a.lov||b.type===a.bool||b.type===a.int||b.type===a.money},fieldIsNumber:function(b){return b.type===a.int||b.type===a.dec||b.type===a.money},fnSearch:function(a,b){var c=a.fnSearch;return _.isFunction(c)?function(c){return a.fnSearch(c,b)}:_.isArray(c)?function(a){for(var d=c.length,e=0;e<d;e++){var f=c[e];if(a.get(f)&&a.get(f).toLowerCase().indexOf(b)>-1)return!0}return!1}:_.isString(c)?function(a){return!!a.get(fn)&&a.get(fn).toLowerCase().indexOf(b)>-1}:void 0},getFields:function(a,b){function c(a){a&&a.elements&&a.elements.length>0?_.each(a.elements,function(a){a.elements?"panel-list"!=a.type&&c(a):d.push(a)}):d.push(a)}var d=[];return c(a),_.isFunction(b)&&(d=_.filter(d,b)),d},getFieldsHash:function(a){var b={};return _.each(a,function(a){b[a.id]=a}),b},getSubCollecs:function(a){function b(a){"panel-list"===a.type?c[a.attribute]=a:"panel"!==a.type&&a.elements&&a.elements.length>0?_.each(a.elements,function(a){"panel-list"===a.type?c[a.attribute]=a:"panel"!==a.type&&b(a)}):c[a.attribute]=a}var c={};return b(a),c},countBy:function(a,b,c,d){var e,f,g=Evol.Def.fieldTypes,h=Evol.i18n,i=[],j=[];if(b.type===g.bool){groups=_.countBy(a,function(a){return a.get(b.id)===!0});for(f in groups)e=groups[f],"true"===f?lb=b.labelTrue||h.yes:lb=b.labelFalse||h.no,i.push(e),j.push(lb+" ("+e+")")}else{groups=_.countBy(a,function(a){return a.get(b.id)});for(f in groups)e=groups[f],_.isUndefined(f)?lb=h.na:""===f||"null"===f?lb=h.none:b.type===g.lov||b.type===g.list?b.list&&b.list.length&&b.list[0].icon?lb=Evol.Dico.lovItemTextNoPix(b,f):lb=Evol.Dico.lovItemText(b,f,Evol.hashLov,d):lb=f,i.push(e),j.push(lb+" ("+e+")")}return chartType=b.typeChart||(b.type===g.lov?"pie":"bars"),c[b.id]={field:b,data:i,labels:j},{data:i,labels:j}},sampleDatum:function(b,c){function d(a){return String.fromCharCode(97+a)+String.fromCharCode(98+a)+String.fromCharCode(99+a)}switch(b.type){case a.bool:return!0;case a.date:return"2015-0"+(c+1)+"-"+(c+14);case a.datetime:return"2015-04-23T17:15";case a.time:return"14:30";case a.url:return"http://www.evolutility.org";case a.email:return"abc@abc.com";case a.int:return b.min?b.min+5+2*c:c;case a.dec:case a.money:return 10.2*(c+1);case a.lov:if(b.list&&b.list.length)return c<b.list.length?b.list[c].id:b.list[0].id;break;default:return d(c)}}}}();var Evol=Evol||{};Evol.Format={capitalize:function(a){return a&&a.length>0?a.substring(0,1).toUpperCase()+a.substring(1):""},trim:function(a){return _.isString(a)&&""!==a?a.replace(/^\s+|\s+$/g,""):""},cr2br:function(a,b){if(""===a||null===a||_.isUndefined(a))return"";var c=b?_.escape(a):a;return c.replace(/[\r\n]/g,"<br>")},dateString:function(a){if(a&&(a=a.substring(0,10)),!_.isUndefined(a)&&null!==a){var b=a.split("-");if(b.length>1)return b[1]+"/"+b[2]+"/"+b[0]}return""},timeString:function(a){if(!_.isUndefined(a)&&null!==a&&""!==a){var b=a.split(":"),c=parseInt(b[0],10);return c>12?c-12+":"+b[1]+" PM":c+":"+b[1]+" AM"}return""},datetimeString:function(a){if(!_.isUndefined(a)&&null!==a&&""!==a){var b=a.split("T");return b.length>1?this.dateString(b[0])+", "+this.timeString(b[1]):this.dateString(b[0])}return""},jsonString:function(a,b){var c;try{c=_.isString(a)&&""!==a?$.parseJSON(_.unescape(a)):a}catch(a){alert("Error: format.jsonString"+a),c={error:"Evol.Format.jsonString"}}if(""===c)return c;var d=JSON.stringify(c,null,2);return b&&(d=this.cr2br(d)),d}};var Evol=Evol||{};Evol.hashLov={},Evol.ViewAction={},Evol.DOM={html:{trTableEnd:"</tr></table>",TdTrTableEnd:"</td></tr></table>",clearer:'<div class="clearfix"></div>',emptyOption:'<option value=""> - </option>',glyphicon:"glyphicon glyphicon-",required:'<span class="evol-required">*</span>',buttonClose:'<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>'},label:function(a,b){return'<label for="'+a+'">'+b+"</label>"},fieldLabel:function(a,b){return'<div class="evol-field-label">'+this.label(a,b)+"</div>"},fieldLabelSpan:function(a,b){return'<span class="evol-field-label">'+this.label(a,b)+"</span>"},input:{formula:function(a,b,c){return'<div class="disabled evo-rdonly evol-ellipsis'+(a?'" id ="'+a:"")+'">'+(b.formula?b.formula(c):"")+"</div>"},text:function(a,b,c,d){var e='<input type="text" id="'+a;return b&&_.isString(b)&&(b=b.replace(/"/g,'"')),e+='" value="'+b,e+='" class="evo-field form-control '+(d||""),c&&(_.each(["id","min","max","maxLength","placeholder"],function(a){_.isUndefined(c[a])||(e+='" '+a+'="'+c[a])}),c.readonly&&(e+='" disabled="disabled')),e+='">'},textInt:function(a,b,c,d){var e='<input class="evo-field form-control" type="number" id="'+a+'" value="'+b;return _.isUndefined(c)||(e+='" min="'+c),_.isUndefined(d)||(e+='" max="'+d),e+='" maxlength="12">'},textM:function(a,b,c,d,e){return'<textarea id="'+a+'" class="evo-field form-control" rows="'+d+'"'+(e?" disabled":"")+">"+b+"</textarea>"},textMJSON:function(a,b,c,d){return'<textarea id="'+a+'" rows="'+c+'" class="evol-json evo-field form-control"'+(d?" disabled":"")+">"+Evol.Format.jsonString(b,!1)+"</textarea>"},myType:function(a,b,c){return'<input type="'+a+'" id="'+b+'" value="'+c+'" class="evo-field form-control" size="15">'},date:function(a,b){return this.myType("date",a,(b||"").substring(0,10))},dateTime:function(a,b){return this.myType("datetime-local",a,b)},time:function(a,b){return this.myType("time",a,b)},typeFlag:function(a){return'<span class="input-group-addon">'+a+"</span>"},color:function(a,b){return'<input type="color" id="'+a+'" value="'+b+'" size="15">'},colorBox:function(a,b,c){return'<div class="evo-color-box" id="'+a+'" style="background-color:'+b+'" title="'+b+'">'+(c?"<span>"+c+"</span>":"")+"</div>"},checkbox:function(a,b){return'<input type="checkbox" id="'+a+(b?'" checked="checked':"")+'" value="1">'},checkbox2:function(a,b,c){return'<input type="checkbox" data-id="'+a+'" class="'+c+'"'+(b?' checked="checked"':"")+' value="1">'},checkboxLOV:function(a){return _.map(a,function(a){return'<input type="checkbox" id="'+a.id+'" value="'+a.id+'"/><label for="'+a.id+'">'+a.text+"</label> "}).join("")},radio:function(a,b,c,d,e){return'<label for="'+e+'"><input id="'+e+'" name="'+a+'" type="radio" value="'+b+(d?'" checked="checked':"")+'">'+c+"</label>&nbsp;"},lov:function(a,b,c,d){var e='<select class="evo-field form-control" id="'+a+'">';return c&&(e+='<option value="'+b+'" selected>'+c+"</option>"),opt=this.option,_.each(d,function(a){e+=opt(a.id,a.text)}),e+="</select>"},img:function(a,b,c){return'<img id="'+a+'" src="'+b.replace(/"/g,'"')+(c?'" class="'+c:"")+'">'},hidden:function(a,b){return'<input type="hidden" name="'+a+'" id="'+a+'" value="'+b.replace(/"/g,'"')+'"/>'},selectBegin:function(a,b,c){return'<select id="'+a+'" class="form-control '+b+'">'+(c?Evol.DOM.html.emptyOption:"")},select:function(a,b,c,d,e){return this.selectBegin(a,c,d)+this.options(e,b)+"</select>"},option:function(a,b,c){return'<option value="'+a+(c?'" selected':'"')+">"+b+"</option>"},options:function(a,b){var c=this.option,d="";return _.each(a,function(a){d+=a.id===b?'<option value="'+a.id+'" selected="selected">'+a.text+"</option>":c(a.id,a.text)}),d}},toggleCheckbox:function(a,b){b?a.prop("checked","checked"):a.prop("checked",!1)},button:function(a,b,c){return'<button type="button" data-id="'+a+'" class="btn'+(c?" "+c:"")+'">'+b+"</button>"},buttonsIcon:function(a,b){return'<div data-id="'+a+'" class="'+this.html.glyphicon+b+'" tabindex="0"></div>'},buttonsPlus:function(){return this.buttonsIcon("bPlus","plus-sign")},buttonsMinus:function(){return this.buttonsIcon("bMinus","minus-sign")},buttonsPlusMinus:function(){return this.buttonsPlus()+this.buttonsMinus()},link:function(a,b,c,d){var e='<a class="evo-field" href="'+encodeURI(c);return a&&(e+='" id="'+a),d&&(e+='" target="'+d),e+='">'+_.escape(b)+"</a>"},linkEmail:function(a,b){return b?this.link(a,b,"mailto:"+b):""},icon:function(a,b){return'<i class="'+(b?b+" ":"")+Evol.DOM.html.glyphicon+a+'"></i>'},iconId:function(a,b,c){return'<i class="'+this.html.glyphicon+c+'" data-id="'+a+(b?'" data-type="'+b:"")+'"></i>'},htmlIcon:function(a,b,c){return'<div class="glyphicon '+c+'" data-id="'+a+'" data-ctype="'+b+'"></div>'},menu:{hBegin:function(a,b,c,d,e){var f="<"+b+' class="dropdown" data-id="'+a+(e?'" data-cardi="'+e:"")+'"><a href="#" class="dropdown-toggle" data-toggle="dropdown">';return d&&(f+=d),c&&(f+=Evol.DOM.icon(c)),f+=' <b class="caret"></b></a><ul class="dropdown-menu evo-dropdown-icons">'},hEnd:function(a){return"</ul></"+a+">"},hItem:function(a,b,c,d,e){var f='<li data-id="'+a;return d&&(f+='" data-cardi="'+d),f+='" data-balloon-pos="down" data-balloon="'+b,f+='"><a href="javascript:void(0);" data-id="'+a+'">'+Evol.DOM.icon(c),f+="</a></li>"}},modal:{alert:function(a,b){var c=$(this.HTMLModal("alert",a,b,[{id:"ok",text:Evol.i18n.tools.bOK,class:"btn-primary"}])).on("click","button",function(a){c.remove()}).modal("show")},confirm:function(a,b,c,d,e){var f=$(this.HTMLModal(a,b,c,e)).on("click","button",function(a){var b=$(a.currentTarget).data("id");d&&d[b]&&d[b](),f.remove()}).modal("show")},HTMLModal:function(a,b,c,d){var e=function(a,b,c){return'<button data-id="'+a+'" type="button" class="btn '+c+'" data-dismiss="modal">'+b+"</button>"},f='<div class="modal fade" id="'+a+'" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button><h4 class="modal-title">'+b+'</h4></div><div class="modal-body">'+c+'</div><div class="modal-footer">';return d||(d=[{id:"cancel",text:Evol.i18n.tools.bCancel,class:"btn-default"},{id:"ok",text:Evol.i18n.tools.bOK,class:"btn-primary"}]),_.each(d,function(a){f+=e(a.id,a.text,a.class)}),f+="</div></div></div></div>"}},panelBegin:function(a,b,c){var d='<div class="panel '+(a.css?a.css:b);return a.id&&(d+='" data-pid="'+a.id),d+='">',(a.label||a.label2)&&(d+=this.panelHeader(a,c)),d},panelHeader:function(a,b){return a.label||a.label2?'<div class="panel-heading '+(a.cssLabel?a.cssLabel:"")+'">'+(b!==!1?this.icon("chevron-up","evol-title-toggle"):"")+'<h3 class="panel-title">'+a.label+"</h3>"+(a.label2?'<div class="evol-subtitle">'+a.label2+"</div>":"")+(a.help?'<p class="evo-panel-help">'+a.help+"</p>":"")+"</div>":""},panelEnd:function(){return"</div>"},panelEmpty:function(a,b,c){return'<div data-id="'+a+'" class="'+b+" panel panel-"+c+'"></div>'},HTMLMsg:function(a,b,c){return'<div data-id="msg" class="evo-msg alert alert-'+(c||"info")+' alert-dismissable">'+this.html.buttonClose+"<strong>"+a+"</strong> <span>"+b+"</span></div>"},showOrHide:function(a,b){a?b?a.show():a.hide():console.log('ERROR: invalid element in "showOrHide".')},addRemClass:function(a,b,c){return b?a.addClass(c):a.removeClass(c),b},scroll2Top:function(){window.scrollTo(0,0)}},Evol.DOM.Charts={colors:["1f77b4","ff7f0e","2ca02c","d62728","9467bd","8c564b","e377c2","7f7f7f","bcbd22","17becf"],_colorsList:function(a){return this.colors.slice(0,a).join(",")},URL:"http://chart.apis.google.com/chart",_HTML:function(a,b,c){return'<div class="evol-chart-title">'+a+'</div><img src="'+b+'">'},Pie:function(a,b,c,d,e){var f=e?e:"390x200",g=this.URL+"?chd=t:"+b.join(",")+"&chco="+this._colorsList(b.length)+"&amp;chl="+c.join("|")+"&amp;cht=p&amp;chs="+f;return this._HTML(a,g,d||"panel-default")},Bars:function(a,b,c,d,e){var f=e?e:"360x200",g=_.max(b),h=this.URL+"?chbh=a&amp;chs="+f+"&cht=bvg&chco="+this._colorsList(b.length)+"&chds=0,"+g+"&amp;chd=t:"+b.join("|")+"&amp;chp=0.05&amp;chts=676767,10.5&amp;chdl="+c.join("|");return this._HTML(a,h,d)}};var Evol=Evol||{};Evol.Dico=function(){var a=Evol.DOM,b=a.input,c=Evol.i18n,d=Evol.Def.fieldTypes;return{fieldEdit:{field:function(a,c,d,e){return b[c](d,e,a,null)},default:function(a,c,d){return b.text(c,d,a,null)},text:function(a,c,d){return b.text(c,d,a,null)},textmultiline:function(a,c,d){if(null===a.height)a.height=5;else{var e=parseInt(a.height,10);e<1&&(a.height=5)}return b.textM(c,d,a.maxlength,a.height)},boolean:function(a,c,d){return b.checkbox(c,d)},integer:function(a,c,d){return b.textInt(c,d,a.max,a.min)},decimal:function(a,c,d){return b.textInt(c,d,a.max,a.min)},money:function(a,c,d){return'<div class="input-group evol-money">'+b.typeFlag("$")+b.textInt(c,d,a.max,a.min)+"</div>"},date:function(a,c,d){return b.date(c,d)},datetime:function(a,c,d){return b.dateTime(c,d)},time:function(a,c,d){return b.time(c,d)},lov:function(a,c,d){return b.select(c,d,"",!0,a.list)},list:function(a,b,c){return'<div id="'+b+'" class="w-100 form-control"></div>'},email:function(a,d,e){return'<div class="input-group">'+b.typeFlag(c.msg.sgn_email)+b.text(d,e,a)+"</div>"},url:function(a,c,d){return b.text(c,d,a)},image:function(a,d,e,f){var g="";return g+=""!==e?'<img src="'+(".."===e.substr(0,2)?e:f+e)+'" class="img-thumbnail">':'<p class="">'+c.nopix+"</p>",g+=b.text(d,e,a,null)},color:function(a,c,d){return b.color(c,d)},hidden:function(a,c,d){return b.hidden(c,d)},html:function(a,c,d){return b.textM(c,d,a.maxlength,a.height)},json:function(a,c,d){return b.textM(c,d,a.maxlength,a.height)},formula:function(a,c,d){return'<div class="evol-ellipsis">'+b.text(c,d,a,null)+"</div>"}},fieldHTML:function(a,c,e,f,g,h){function i(a){var b=parseInt(a.height||2,10);return b<2&&(b=2),parseInt(1.6*b,10)}var j="";if(h||(j+=this.HTMLFieldLabel(a,f||"edit")),a.readonly||"browse"===f){switch(j+='<div class="disabled evo-rdonly'+(a.type===d.email||a.type===d.url?" evol-ellipsis":"")+'" id="'+c,a.type===d.textml&&a.height>1&&(j+='" style="height:'+i(a)+"em;overflow-y: auto;"),j+='">',a.type){case d.formula:j+='<div id="'+c+'" class="form-control evol-ellipsis">'+a.formula()+"</div>";break;case d.color:j+='<div id="'+c+'" class="form-control">'+b.colorBox(c,e)+"</div>";break;default:j+=this.fieldHTML_RO(a,e,{},g)}j+="&nbsp;</div>"}else{var k=Evol.Dico.fieldEdit[a.type];k||(k=Evol.Dico.fieldEdit.default),j+=k(a,c,e,g)}return j},fieldHTML_RO:function(c,e,f,g,h){switch(c.type){case d.bool:if("true"===e||"1"==e)return a.icon("ok",c.css);break;case d.lov:if(""!==e)return Evol.Dico.lovItemText(c,e,f,g);break;case d.list:return _.isString(e)&&""!==e&&(e=e.split(",")),e&&e.length&&""!==e[0]?'<div class="evo-f-list"><div>'+_.map(e,function(a){return Evol.Dico.lovItemText(c,a,f,g)}).join("</div><div>")+"</div></div>":"";case d.date:case d.time:case d.datetime:return Evol.Format[c.type+"String"](e);case d.pix:if(e&&e.length)return b.img(c.id,g+e,"img-thumbnail");break;case d.money:var i=parseFloat(e);if(!isNaN(i))return"$"+i.toFixed(2);break;case d.email:return a.linkEmail(h?c.id:null,e);case d.url:return a.link(c.id,e,e,c.id);case d.json:return a.input.textM(c.id,Evol.Format.jsonString(e,!1),c.maxLen,c.height,!0);default:return e}return""},HTMLFieldLabel:function(b,c){var d='<div class="evol-field-label" id="'+b.id+'-lbl"><label class="control-label '+(b.cssLabel?b.cssLabel:"")+'" for="'+b.id+'">'+b.label;return"browse"!=c&&b.required&&(d+=a.html.required),b.help&&""!==b.help&&(d+=a.icon("question-sign","")),d+="</label></div>"},fieldLink:function(a,b,c,d,e,f){var g="";if(!e){var h="javascript";g+='<a href="'+(f?f:h+":void(0);"),a&&(g+='" id="'+a),g+='" class="evol-nav-id">'}return d&&(g+='<img class="evol-many-icon" src="'+d+'">'),g+="<span>"+c+"</span>",e||(g+="</a>"),g},clearCacheLOV:function(){Evol.hashLov={}},setViewTitle:function(a,b,c){return a.titleSelector&&$(a.titleSelector).html((a.icon?'<i class="glyphicon glyphicon-'+a.icon+'"></i>&nbsp;':"")+(b?b:a.getTitle())+(c?'<span class="badge badge-one">'+c+"</span>":"")),a},getFieldVal:function(a,b){switch(a.type){case d.bool:return b.prop("checked");case d.int:return parseInt(b.val(),10);case d.dec:case d.money:return parseFloat(b.val());case d.list:try{return b.select2("val")}catch(a){return console.error("error with select2"),""}break;case d.date:var c=b.val();return 10===c.length&&(c+="T08:00:00.000Z"),c;default:return b.val()}},lovItemText:function(a,b,c,d,e){if(a.list&&a.list.length>0&&c){a.id in c||(c[a.id]={});var f=c[a.id];if(b in f)return f[b];var g=_.find(a.list,function(a){return a.id==b});if(g){var h=_.escape(g.text);return g.glyphicon?h='<i class="glyphicon glyphicon-'+g.glyphicon+'"></i> '+h:g.icon&&(h='<img src="'+(g.icon&&"."!==g.icon.substring(0,1)?d:"")+g.icon+'"> '+h),f[b]=h,h}}return""},lovItemTextNoPix:function(a,b){var c=_.find(a.list,function(a){return a.id==b});return c?c.text:""},filterModels:function(a,b){if(b.length){var c=Evol.Dico.fieldConditions;return a.filter(function(a){for(var d=!0,e=0,f=b.length;e<f;e++){var g=b[e],h=a.get(g.field.value);if(_.isArray(h)){for(var i=h.length,j=!1,k=0;k<i;k++)if(c[g.operator.value](h[k],g.value.value)){j=!0;break}if(!j)return j}else if(_.isUndefined(h)&&(h=""),!c[g.operator.value](h,g.value.value,g.value.value2))return!1}return d})}return a},bbComparator:function(a){return function(b){return b.get(a)}},bbComparatorText:function(a){return function(b,c){return(b.get(a)||"").localeCompare(c.get(a)||"")}},bbComparatorFormula:function(a,b){return function(a,c){var d=b(a),e=b(c);return d<e?1:e<d?-1:0}},sortNumber:function(a){return function(b,c){return b[a]<c[a]?1:c[a]<b[a]?-1:0}},sortText:function(a){return function(b,c){return(b[a]||"").localeCompare(c[a]||"")}},setPageTitle:function(a){_.isUndefined(this._$headTitle)&&(this._$headTitle=$("#headTitle")),this._$headTitle.html(a)},getItemTitle:function(a){return a.find("h4>a>span").text()},getRoute:function(){var a=window.location.href,b=a.indexOf("#");return b>-1?a.substr(b+1):""},setRoute:function(a,b,c,d,e){if(!_.isUndefined(a)){var f=b+"/"+c;d&&(f+="/"+d),f!==this.getRoute()&&a.navigate("#"+f,{trigger:e})}},fieldConditions:{eq:function(a,b){return b==a},ne:function(a,b){return b!=a},gt:function(a,b){return a>b},lt:function(a,b){return a<b},bw:function(a,b,c){return!(b>a||a>c)},sw:function(a,b){return a.substring(0,b.length).toLocaleLowerCase()===b},ct:function(a,b){return!!a&&a.toLocaleLowerCase().indexOf(b)>-1},nct:function(a,b){return!a||a.toLocaleLowerCase().indexOf(b)===-1},fw:function(a,b){var c=a.length,d=b.length;return!(c<d)&&a.toLocaleLowerCase().substring(c-d)===b},null:function(a,b){return""===a||_.isUndefined(a)},nn:function(a,b){return!(_.isUndefined(a)||""===a)},in:function(a,b){if(_.isArray(a)){for(var c=b.split(","),d=0;d<a.length;d++)if(_.contains(c,a[d]))return!0;return!1}return _.contains(b.split(","),a)},1:function(a,b){return a},0:function(a,b){return!a}}}}();var Evol=Evol||{};Evol.ViewMany={menuOne:[{id:"edit",type:null,icon:"edit"},{id:"delete",type:null,icon:"trash"}],eventsMany:{"click .pagination>li":"click_pagination","click .evol-actions>i,.evol-actions-nxtTd>i":"clickAction","change .list-sel":"click_selection",'change [data-id="cbxAll"]':"click_checkall"},actionEvents:{enterItem:function(a,b,c){return function(d){var e=$(d.currentTarget),f="evol-actions";b&&(e=b(e)),c&&e.width()<190&&e.siblings().length>e.index()&&(e=e.next(),f="evol-actions-nxtTd"),e.append('<div class="'+f+'">'+_.map(a,function(a){return Evol.DOM.iconId(a.id,a.type,a.icon)}).join("")+"</div>")}},leaveItem:function(a){$(a.currentTarget).find(".evol-actions,.evol-actions-nxtTd").remove()}}},Evol.View_Many=function(){var a=Evol.DOM,b=Evol.Dico,c=Evol.i18n;return Backbone.View.extend({viewName:"Many",viewType:"many",cardinality:"n",options:{style:"panel-default",pageSize:20,pageIndex:0,autoUpdate:!1,links:!0,noDataString:c.nodata,iconsPath:"pix/",fieldsetFilter:function(a){return a.inMany}},events:Evol.ViewMany.eventsMany,initialize:function(a){var b=localStorage.getItem(a.uiModel.id+"-sort"),c=this;if(_.extend(this,this.options,a),this.mode=this.mode||"",this._filter=[],this.autoUpdate&&this.collection&&this.collection.on("change",function(){c.render()}),this.router||this.$el.on("click",".evol-nav-id",function(a){c.click_navigate(a)}),null!==b){var d=b.split("-"),e=this.getField(d[0]);d.length>1&&!_.isUndefined(e)&&this.sortList(e,"down"===d[1],!0,!0)}},render:function(){var c=this.collection?this.collection.models:null;return this.collection&&this.collection.length?(c=b.filterModels(c,this._filter),this._render(c)):this.$el.html(a.HTMLMsg(this.noDataString,"","info")),this.setTitle()},_HTMLbody:function(a,b,c,d,e){var f=[],g=this.collection.models,h=d>0?d*b:0,i=_.min([g.length,h+b]),j=c?(this.iconsPath||"")+c:null;if(i>0)for(var k=this.getItemRoute(),l=h;l<i;l++)this.HTMLItem(f,a,g[l],j,e,k);return f.join("")},_render:function(a){alert("_render must be overridden")},_HTMLField:function(a,c){if("formula"===a.type){var d='<div class="disabled evo-rdonly evol-ellipsis">';return a.formula&&this.model&&(d+=a.formula(this.model)),d+="</div>"}return b.fieldHTML_RO(a,c,Evol.hashLov,this.iconsPath||"")},_HTMLCheckbox:function(b){return a.input.checkbox2(b,!1,"list-sel")},setCollection:function(a){return this.collection=a,this.render()},getCollection:function(){return this.collection},setFilter:function(a){return this._filter=a,this},getFilter:function(){return this._filter},setTitle:function(a){return b.setViewTitle(this,a||this.getTitle())},getTitle:function(){return Evol.Format.capitalize(this.uiModel.namePlural)+" "+this.viewName},getFields:function(){if(!this._fields){this._fields=Evol.Def.getFields(this.uiModel,this.fieldsetFilter),this._fieldHash={};var a=this._fieldHash;_.each(this._fields,function(b){a[b.id]=b})}return this._fields},getField:function(a){return this._fieldHash||this.getFields(),this._fieldHash[a]},setPage:function(a){var b=this.getFields(),c=this.pageSize,d=this.collection.length,e=this._pageSummary(a,c,d);return this._$body().html(this._HTMLbody(b,c,this.uiModel.icon,a,this.selectable)),this.$(".evo-pagination").html(this._HTMLpaginationBody(a,c,d)),this.$(".evo-many-summary").html(e),this.pageIndex=a,this.$el.trigger("status",e),this},getPage:function(){return this.pageIndex},_$Selection:function(){return this.$(".list-sel:checked").not('[data-id="cbxAll"]')},getSelection:function(){return this.selectable?_.map(this._$Selection().toArray(),function(a){return $(a).data("id")}):[]},setSelection:function(a){if(this.selectable&&a.length>0){var b=[];_.each(a,function(a){b.push("[data-mid="+a+"] .list-sel")}),this.$(b.join(",")).prop("checked",!0)}return this},pageSummary:function(){return this._pageSummary(this.pageIndex,this.pageSize,this.collection.length)},_pageSummary:function(a,b,d){if(0===d)return"";if(1===d)return d+" "+this.uiModel.name;if(b>=d)return d+" "+this.uiModel.namePlural;var e,f=(a||0)*b+1;return e=a<1?_.min([b,d]):_.min([f+b-1,d]),c.range.replace("{0}",f).replace("{1}",e).replace("{2}",d).replace("{3}",this.uiModel.namePlural)},_HTMLpagination:function(a,b,c){return c>b?'<ul class="evo-pagination pagination pagination-sm">'+this._HTMLpaginationBody(a,b,c)+"</ul>":""},_HTMLpaginationBody:function(a,b,c){var d="";if(c>b){var e,f=Math.ceil(c/b),g=a+1,h=function(a){d+="<li"+(g===a?' class="active"':"")+' data-id="'+a+'"><a href="javascript:void(0)">'+a+"</a></li>"},i=function(a,b){for(var c=a;c<=b;c++)h(c)},j=function(){d+='<li class="disabled"><a href="javascript:void(0)">...</a></li>'};d+='<li data-id="prev"'+(1===g?' class="disabled"':"")+'><a href="javascript:void(0)">&lt;</a></li>',h(1),g>4&&f>6?(5===g?h(2):j(),e=_.min([g+2,f]),i(_.max([2,g-2]),e)):(e=_.min([_.max([5,g+2]),f]),i(2,e)),e<f&&g+2<f&&(j(),h(f)),d+='<li data-id="next"'+(f>g?"":' class="disabled"')+'><a href="javascript:void(0)">&gt;</a></li>'}return d},sortList:function(a,c,d,e){var f=this.collection,g=Evol.Def.fieldTypes;if(!_.isUndefined(f)){var h=this.getSelection();a.type==g.text||a.type==g.textml||a.type==g.email?f.comparator=b.bbComparatorText(a.id):a.type===g.formula?f.comparator=b.bbComparatorFormula(a.id,a.formula):f.comparator=b.bbComparator(a.id),f.sort(),c&&f.models.reverse(),this.setPage(0);var i=c?"down":"up";d||localStorage.setItem(this.uiModel.id+"-sort",a.id+"-"+i),this.setSelection(h),e||this.$el.trigger("sort.many",{id:a.id,direction:i})}return this},getItemRoute:function(){return this.router?"#"+this.uiModel.id+"/browse/":null},click_navigate:function(a){var b=$(a.currentTarget).closest("[data-mid]").data("mid");a.type="navigate.many",this.$el.trigger(a,{id:b})},click_pagination:function(a){this.$el.trigger("paginate.many",{id:$(a.currentTarget).closest("li").data("id")})},click_selection:function(a){this.$el.trigger("selection.many")},click_checkall:function(a){var b=this.$('[data-id="cbxAll"]').prop("checked");this.$(".list-sel").prop("checked",b),this.$el.trigger("selection.many")}})}();var Evol=Evol||{};Evol.Bubbles=function(){var a=(Evol.Def.fieldTypes,function(a){_.extend(this,a),this.fieldsH={};for(var b in this.fields){var c=this.fields[b];this.fieldsH[c.id]=c}return this});return a.prototype._initialize=function(){this.graphInitialized||(this.svg=d3.select(this.elem).append("svg").attr("width",this.width).attr("height",this.height),this.force=d3.layout.force(),this.graphInitialized=!0)},a.prototype.fixData=function(a){return _.map(a,function(a){return a})},a.prototype.setData=function(a){function b(){$(".popover").each(function(){$(this).remove()})}function c(a){$(this).popover({animation:!0,placement:"auto top",container:"body",trigger:"manual",html:!0,content:d.tooltip(a)}),$(this).popover("show",500),d3&&d3.select(".popover").style("opacity",0).transition().duration(500).style("opacity",1)}var d=this,e=a.length,f=e<17?20:e<100?16:10;if(this.defaultSize=f,this.sizeFieldId){var g=_.map(a,function(a){var b=a[d.sizeFieldId];return(null===b||_.isNaN(b))&&(b=0),b});this.plotScale=d3.scale.log().domain([_.min(g),_.max(g)]).range([f,f+20])}else this.plotScale=function(a){return f};this.fill=e<11?d3.scale.category10():d3.scale.category20(),this.data=a;for(var h=0;h<a.length;h++)a[h].radius=f,a[h].x=Math.random()*this.width,a[h].y=Math.random()*this.height;this._initialize(),this.maxRadius=d3.max(_.pluck(a,"radius")),this.nodes=this.svg.selectAll("circle").data(a),this.nodes.enter().append("circle").attr("class","node").attr("data-mid",function(a){return a.id}).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}).attr("r",function(a){return a.radius}).style("fill",function(a){return d.fill(a[d.colorFieldId])}).on("mouseenter",c).on("mouseleave",b).on("click",b),this.nodes.attr("data-mid",function(a){return a.id}).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}).attr("r",function(a){return a.radius}).style("fill",function(a){return d.fill(a[d.colorFieldId])}),this.nodes.exit().remove(),this.changeBubblesSize(this.sizeFieldId),this.changeBubblesGroup(this.groupFieldId)},a.prototype.getCenters=function(a,b,c){var d,e,f=this.fieldsH[a],g="N/A";if(d=_.uniq(_.pluck(c,a)).map(function(a){return{name:a,value:1}}),f)if("lov"===f.type){var h={};_.forEach(f.list,function(a){h[a.id]=a.text}),_.forEach(d,function(a){a.label=h[a.name]||g}),d=d.sort(Evol.Dico.sortText("label"))}else if("boolean"===f.type)_.forEach(d,function(a){a.name===!0?a.label=f.labelTrue||Evol.i18n.yes:a.name===!1?a.label=f.labelFalse||Evol.i18n.no:a.label=g});else if(Evol.Def.fieldIsNumber(f)){d=d.sort(Evol.Dico.sortNumber("name"));var i=_.findWhere(d,{name:null});i&&(i.label=g)}return e=d3.layout.treemap().size(b).ratio(1),e.nodes({children:d}),
d},a.prototype.changeBubblesGroup=function(a){var b=this.getCenters(a,[800,600],this.data);this.groupFieldId=a,this.force.on("tick",this.tick(b,a,this.data)),this.labels(b),this.force.start()},a.prototype.changeBubblesColor=function(a){var b=this;this.colorFieldId=a,this.fill=d3.scale.category10(),this.svg.selectAll("circle").transition().duration(500).style("fill",function(c){return a?b.fill(c[a]):"rgb(31, 119, 180)"})},a.prototype.changeBubblesSize=function(a){var b=this;this.sizeFieldId=a;var c=this.svg.selectAll("circle");if(a){var d=_.map(this.data,function(b){var c=b[a];return null===c||c===isNaN||_.isUndefined(c)?0:c});this.plotScale=d3.scale.log().domain([_.min(d),_.max(d)]).range([10,25]),c.transition().duration(500).attr("r",function(c){var d=a?b.plotScale(c[a]||0):10;return(null===d||_.isNaN(d))&&(d=b.defaultSize),d})}else c.transition().duration(500).attr("r",b.defaultSize)},a.prototype.tick=function(a,b){for(var c=this,d={},e=0;e<a.length;e++)d[a[e].name]=a[e];return function(a){for(var e=0;e<c.data.length;e++){var f=c.data[e],g=d[f[b]];f.y+=(g.y+g.dy/2-f.y)*a.alpha,f.x+=(g.x+g.dx/2-f.x)*a.alpha}c.nodes.each(c.collide(.12,c.data)).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y})}},a.prototype.labels=function(a){this.svg.selectAll(".label").remove(),this.svg.selectAll(".label").data(a).enter().append("text").attr("class","label").text(function(a){return a.label||a.name}).attr("transform",function(a){return"translate("+(a.x+a.dx/2)+", "+(a.y+20)+")"})},a.prototype.collide=function(a,b){var c=d3.geom.quadtree(b),d=this.maxRadius,e=2;return function(b){var f=b.radius+d+e,g=b.x-f,h=b.x+f,i=b.y-f,j=b.y+f;c.visit(function(c,d,f,k,l){if(c.point&&c.point!==b){var m=b.x-c.point.x,n=b.y-c.point.y,o=Math.sqrt(m*m+n*n),p=b.radius+c.point.radius+e;o<p&&(o=(o-p)/o*a,b.x-=m*=o,b.y-=n*=o,c.point.x+=m,c.point.y+=n)}return d>h||k<g||f>j||l<i})}},a}(),Evol.ViewMany.Bubbles=Evol.View_Many.extend({viewName:"bubbles",icon:"adjust",events:{"click .btn":"clickGroup","change .bubble-group":"changeGroup","change .bubble-color":"changeColor","change .bubble-size":"changeSize","click svg>circle":"clickCircle"},fieldsetFilter:Evol.Def.fieldChartable,setupBubbles:function(){var a=this,b=(this.uiModel,this.collection.models);if(!this._bubblesInitialized){var c=Evol.Def.getFields(this.uiModel,Evol.Def.fieldChartable),d=c.length?c[0].id:null;this.bubbles=new Evol.Bubbles({elem:this.$(".evol-bubbles-body").get(0),width:1200,height:700,fields:c,colorFieldId:d,groupFieldId:d,sizeFieldId:null,uiModel:this.uiModel,tooltip:function(b){var c=[],d=a.getFields();return Evol.ViewMany.Cards.prototype.HTMLItem.call(a,c,d,new Backbone.Model(b),null,null,null,!0),c.join("")}}),this.bubbles.setData(_.map(b,function(a){return _.extend({id:a.id},a.attributes)})),this._bubblesInitialized=!0}},_render:function(a){var b,c=Evol.DOM,d=Evol.i18n.tools,e=c.input.option,f=c.html.emptyOption,g=Evol.Def.getFields(this.uiModel,Evol.Def.fieldChartable),h='<div class="evol-many-bubbles panel '+this.style+'"><div class="evol-bubbles-body"><div class="d3-tooltip" style="opacity:0;"></div>';return h+='<div class="bubbles-opts '+this.style+'">',g.length?(h+="<label>"+d.vizGroupBy+": </label>",g.length>5?(b=_.map(g,function(a,b){return e(a.id,a.label,0===b)}),h+='<select class="form-control bubble-group">'+f+b.join("")+"</select>"):h+='<div class="btn-group" data-toggle="buttons">'+_.map(g,function(a,b){if(_.isUndefined(a.groupable)||a.groupable)return'<label class="btn btn-default'+(0===b?" active":"")+'" id="'+a.id+'"><input type="radio" name="options"'+(0===b?" checked":"")+">"+a.label+"</label>"}).join("")+"</div>",b=_.map(g,function(a,b){return _.isUndefined(a.colorable)||a.colorable?e(a.id,a.label,0===b):""}),h+="<label>"+d.vizColorBy+': </label><select class="form-control bubble-color">'+f+b.join("")+"</select>",g=_.filter(g,function(a){return _.isUndefined(a.sizable)||a.sizable?Evol.Def.fieldIsNumber(a):""}),b=_.map(g,function(a,b){return e(a.id,a.label)}),b.length&&(h+="<label>"+d.vizSizeBy+': </label><select class="form-control bubble-size">'+f+b.join("")+"</select>")):h+=Evol.i18n.notEnoughdata,h+="</div></div></div>",this.$el.html(h),this.setupBubbles(),this},_HTMLbody:function(){},_HTMLlegend:function(){},_$body:function(){return this.$(".evol-bubbles-body")},setCollection:function(a){return this.collection=a,this.bubbles.setData(_.map(a.models,function(a){return _.extend({id:a.id},a.attributes)})),this},clickGroup:function(a){this.bubbles.changeBubblesGroup(a.currentTarget.id)},changeGroup:function(a){this.bubbles.changeBubblesGroup(a.target.value)},changeColor:function(a){this.bubbles.changeBubblesColor(a.target.value)},changeSize:function(a){this.bubbles.changeBubblesSize(a.target.value)},clickCircle:function(a){var b=$(a.currentTarget).data("mid");this.$el.trigger("click.bubble",{id:b}),window.location.href="#"+this.uiModel.id+"/browse/"+b}}),Evol.ViewMany.Cards=Evol.View_Many.extend({viewName:"cards",icon:"th-large",events:_.extend({"mouseenter .evol-cards-body>div":"enterItem","mouseleave .evol-cards-body>div":"leaveItem"},Evol.ViewMany.eventsMany),fieldsetFilter:function(a){return a.inMany||a.inCards},_render:function(a){var b=this.pageSize||50,c=this.pageSummary(0,b,a.length);return this.$el.html('<div class="evol-many-cards"><div class="evol-cards-body">'+this._HTMLbody(this.getFields(),b,this.uiModel.icon,0,this.selectable)+"</div>"+Evol.DOM.html.clearer+this._HTMLpagination(0,b,a.length)+'<div class="evo-many-summary">'+c+"</div></div>"),this},_$body:function(){return this.$(".evol-cards-body")},HTMLItem:function(a,b,c,d,e,f,g){var h,i=this,j=Evol.Def.fieldTypes,k=this.links!==!1,l=Evol.DOM.input;return g?a.push('<div class="evol-bubble-tooltip">'):a.push('<div class="panel '+this.style+'">'),_.each(b,function(b,m){if(b.type===j.color?(h=c.escape(b.attribute||b.id),h=l.colorBox(b.id,h,h)):h="formula"===b.type?l.formula(null,b,c):"image"!==b.type||g?b.type===j.json?c.get(b.attribute||b.id):i._HTMLField(b,c.escape(b.attribute||b.id)):'<a href="#'+f+c.id+'">'+i._HTMLField(b,c.escape(b.attribute||b.id))+"</a>",0===m){a.push('<div data-mid="'+c.id+'">');var n=i.uiModel.fnBadge;n&&(a.push('<span class="badge pull-right">'),_.isFunction(n)?a.push(n(c)):_.isString(n)&&a.push(c.escape(n)),a.push("</span>")),a.push("<h4>"+(e?i._HTMLCheckbox(c.id):"")+Evol.Dico.fieldLink(null,b,h,d,!k,f?f+c.id:null)+"</h4></div>")}else{var o=b.labelCards,p=b.type==j.email||b.type==j.url?'evol-ellipsis"':"";""===o?(p+=b.type==j.pix?'evol-c-center"':"",a.push("<div"+(p?' class="'+p+'"':"")+">"+h+"</div>")):(o||(o=b.labelMany||b.label),a.push('<div class="'+p+'"><label>'+o+":</label> "+h+"</div>"))}}),a.push("</div>"),this},enterItem:Evol.ViewMany.actionEvents.enterItem(Evol.ViewMany.menuOne),leaveItem:Evol.ViewMany.actionEvents.leaveItem,clickAction:function(a){var b=this,c=$(a.currentTarget),d=c.data("id"),e=c.parent().siblings().eq(0).data("mid"),f=c.closest(".panel");"edit"===d?this.$el.trigger("navigate",{id:e,view:d}):this.$el.trigger("action",{id:d,mid:e,title:Evol.Dico.getItemTitle(f),skipWarning:a.shiftKey,fnSuccess:function(a){f.fadeOut(500,function(){f.remove(),b.$el.trigger("status",b.pageSummary())})}})}}),Evol.ViewMany.Charts=function(){var a=Evol.DOM,b=(Evol.Dico,Evol.i18n);return Evol.View_Many.extend({viewName:"charts",icon:"stats",isChart:!0,options:{style:"panel-info",fieldsetFilter:Evol.Def.fieldInCharts,autoUpdate:!1},events:{"mouseenter .evol-many-charts>div":"enterItem","mouseleave .evol-many-charts>div":"leaveItem","click .evol-actions>i":"clickAction"},render:function(){return this.entityName=Evol.Format.capitalize(this.uiModel.namePlural),this.collection&&this.collection.length>0?this.$el.html('<div class="evol-many-'+this.viewName+'">'+this._HTMLcharts(this.style||"panel-info",this.sizes)+"</div>"):this.$el.html(a.HTMLMsg(b.nodata,"","info")),this.setTitle()},_HTMLcharts:function(c,d){var e,f="",g=Evol.Def.fieldTypes,h=(this.uiModel,this.collection.models),i=this.iconsPath||"",j=this.getFields(),k={},l=this.entityName;if(j&&j.length){_.each(j,function(j){var m=Evol.Def.countBy(h,j,k,i),n=m.data,o=m.labels;j.type===g.lov||j.type===g.list;e=j.typeChart||(j.type===g.lov?"pie":"bars"),f+='<div class="evol-chart-holder panel '+c+'"><div class="opts"></div><div class="chart-holder" data-fid="'+j.id+'" data-ctype="'+e+'">',"pie"===e?f+=a.Charts.Pie(j.labelCharts?j.labelCharts:b.getLabel("charts.aByB",l,j.label),n,o,c,d):"bars"===e&&(f+=a.Charts.Bars(j.labelCharts?j.labelCharts:b.getLabel("charts.aB",l,j.label),n,o,c,d)),f+="</div><br></div>"}),this._cData=k}else f+=a.HTMLMsg(b.nochart,b.badchart);return f+=a.html.clearer},setPage:function(){},enterItem:Evol.ViewMany.actionEvents.enterItem([{id:"bars",type:null,icon:"stats"},{id:"pie",type:null,icon:"record"}]),leaveItem:Evol.ViewMany.actionEvents.leaveItem,clickAction:function(c){var d,e,f=$(c.currentTarget),g=f.data("id"),h=f.parent().parent().find(".chart-holder"),i=h.data("ctype"),j=h.data("fid"),k=this._cData[j],l=k.field,m=a.Charts;g!=i&&("bars"===g?(d="Bars",e="charts.aB"):(d="Pie",e="charts.aByB"),h.html(m[d](l.labelCharts?l.labelCharts:b.getLabel(e,this.entityName,l.label),k.data,k.labels,k.style,k.sizes)),h.data("ctype",g))}})}(),Evol.ViewMany.List=Evol.View_Many.extend({viewName:"list",icon:"th-list",events:_.extend({"mouseenter tbody>tr":"enterItem","mouseleave tbody>tr":"leaveItem","click .evol-sort-icons>i":"click_sort"},Evol.ViewMany.eventsMany),fieldsetFilter:function(a){return a.inMany||a.inList},_render:function(a){var b="",c=this,d=this.getFields(),e=this.pageSize||50,f=this.links!==!1;b+='<div class="evol-many-list"><div><table class="table'+(f?" table-hover":"")+'"><thead><tr>',this.selectable&&(b+='<th class="list-td-sel">'+this._HTMLCheckbox("cbxAll")+"</th>"),_.each(d,function(a){b+=c._HTMLlistHeader(a)}),b+="</tr></thead><tbody>"+this._HTMLbody(d,e,this.uiModel.icon,0,this.selectable)+"</tbody></table></div>"+this._HTMLpagination(0,e,a.length)+'<div class="evo-many-summary">'+this.pageSummary(this.pageIndex,e,a.length)+"</div></div>",this.$el.html(b)},_$body:function(){return this.$(".table > tbody")},HTMLItem:function(a,b,c,d,e,f){var g,h=this,i=h.uiModel.fnBadge,j=this.links!==!1,k=Evol.Def.fieldTypes,l=Evol.DOM.input;a.push('<tr data-mid="'+c.id+'">'),e&&a.push('<td class="list-td-sel">'+this._HTMLCheckbox(c.id)+"</td>"),_.each(b,function(b,e){if(g=b.type===k.color?l.colorBox(b.id,c.escape(b.attribute||b.id)):b.type===k.formula?l.formula(null,b,c):b.type===k.json||b.type===k.html?c.get(b.attribute||b.id):h._HTMLField(b,c.escape(b.attribute||b.id)),0===e&&(g=Evol.Dico.fieldLink(null,b,g,d,!j,f?f+c.id:null),i)){var m;_.isFunction(i)?m=i(c)||"":_.isString(i)&&(m=c.escape(i)||""),m&&(g+='<span class="badge badge-list">'+m+"</span>")}var n=b.css||"";b.type===k.email||b.type===k.url?n+=" evol-ellipsis":b.type===k.pix?n+=" evol-td-pix":Evol.Def.fieldIsNumber(b)&&(n+=" evol-r-align"),a.push('<td class="'+n+'">'+g+"</td>")}),a.push("</tr>")},_HTMLlistHeader:function(a){var b='<th><span id="'+a.id+'-lbl">'+(a.labelList||a.labelMany||a.label);return a.sortable!==!1&&(b+='<span class="evol-sort-icons" data-fid="'+a.id+'">'+Evol.DOM.icon("chevron-up")+Evol.DOM.icon("chevron-down")+"</span>"),b+="</span></th>"},click_sort:function(a){var b=$(a.currentTarget),c=b.parent().data("fid"),d=this.getField(c),e=b.attr("class").indexOf("-down")>0;this.sortList(d,e)},enterItem:Evol.ViewMany.actionEvents.enterItem(Evol.ViewMany.menuOne,function(a){return a.children().eq(0)},!0),leaveItem:Evol.ViewMany.actionEvents.leaveItem,clickAction:function(a){var b=this,c=$(a.currentTarget),d=c.data("id"),e=c.closest("tr"),f=e.data("mid");"edit"===d?this.$el.trigger("navigate",{id:f,view:d}):this.$el.trigger("action",{id:d,mid:f,title:c.closest("tr").find("a>span").text(),skipWarning:a.shiftKey,fnSuccess:function(a){e.fadeOut(500,function(){e.remove(),b.$el.trigger("status",b.pageSummary())})}})}});var Evol=Evol||{};Evol.ViewOne={},Evol.View_One=function(){var a=Evol.DOM,b=a.input,c=Evol.i18n,d=(c.tools,Evol.Def),e=Evol.Dico,f=d.fieldTypes;return Backbone.View.extend({viewName:"One",viewType:"one",cardinality:"1",editable:!0,events:{"click .evol-buttons>button":"click_button","click .evol-title-toggle":"click_toggle","click ul.evol-tabs>li>a":"click_tab","click label>.glyphicon-question-sign":"click_help",'click [data-id="bPlus"],[data-id="bMinus"]':"click_detailsAddDel",'keyup [data-id="bPlus"],[data-id="bMinus"]':"click_detailsAddDel"},options:{style:"panel-default",button_addAnother:!1,titleSelector:"#title",iconsPath:"pix/"},initialize:function(a){_.extend(this,this.options,a),this.mode=this.mode||this.viewName,this._tabId=!1,this._subCollecs=this._subCollecsOK=!1},render:function(){var a=[];return this._render(a,this.mode),this.$el.html(a.join("")),this.custOn=!1,this.postRender(),this.setData(this.model,!0),this},postRender:function(){},getFields:function(){if(!this._fields){this._fields=d.getFields(this.uiModel,this.fieldsetFilter),this._fieldHash=d.getFieldsHash(this._fields)}return this._fields},getFieldsHash:function(){return this._fields||this.getFields(),this._fieldHash},getSubCollecs:function(){return this._subCollecsOK||(this._subCollecs=d.getSubCollecs(this.uiModel),this._subCollecsOK=!0),this._subCollecs},setModel:function(a){return this.model=a,this.clearMessages().setData(a,!0)},getModel:function(){return this.model},setUIModel:function(a){return this.uiModel=a,this.clearCache().render()},getUIModel:function(){return this.uiModel},getData:function(a){var b=this,c=this.getFields(),d={},f=this.getSubCollecs();if(a){var g=function(a){return a.readonly!==!0};c=_.filter(c,g),f=_.filter(f,g)}return _.forEach(c,function(a){d[a.id]=b.getFieldValue(a)}),f&&f.length&&_.each(f,function(a){var c,f,g=b.$('[data-pid="'+a.id+'"] tbody tr').not('[data-id="nodata"]').toArray(),h=[];_.each(g,function(b){c={},f=$(b).children(),_.each(a.elements,function(a,b){c[a.id]=e.getFieldVal(a,f.eq(b).find("input,select,textarea").eq(0))}),h.push(c)}),d[a.attr||a.id]=h}),d},setData:function(a,d){if(_.isUndefined(a)||null===a)this.clear();else{var g,h,i,j=this,k=this.getSubCollecs(),l=this.iconsPath;_.each(this.getFields(),function(k){if(g=j.$field(k.id),h=d?a.get(k.attribute||k.id)||"":a[k.attribute||k.id]||"",k.readonly)switch(k.type){case f.pix:i=h?'<img src="'+l+h+'" class="img-thumbnail">':'<p class="">'+c.nopix+"</p>",g.val(h).prev().remove(),g.before(i);break;case f.textml:g.html(Evol.Format.cr2br(h,!0));break;case f.bool:case f.url:case f.email:case f.list:case f.lov:g.html(e.fieldHTML_RO(k,_.isUndefined(h)?"":h,Evol.hashLov,l)+" ");break;case f.formula:g.html(k.formula?k.formula(a):"");break;case f.color:g.html(b.colorBox(k.id,h,h));break;case f.json:g.val(Evol.Format.jsonString(h,!1));break;default:g.text(e.fieldHTML_RO(k,_.isUndefined(h)?"":h,Evol.hashLov,l)+" ")}else switch(k.type){case f.lov:var m=g.children().removeAttr("selected");""!==h&&m.filter("[value="+h+"]").prop("selected","selected");break;case f.bool:g.prop("checked",!!h&&"checked");break;case f.date:h&&(h=h.substring(0,10)),g.val(h);break;case f.pix:i=h?'<img src="'+l+h+'" class="img-thumbnail">':'<p class="">'+c.nopix+"</p>",g.val(h).prev().remove(),g.before(i);break;case f.list:try{g.select2("val",_.isString(h)?[h]:h)}catch(a){return console.error("error with select2"),""}break;case f.formula:g.html(k.formula?k.formula(a):"");break;case f.json:g.val(Evol.Format.jsonString(h,!1));break;default:g.val(h)}}),k&&_.forEach(k,function(a){var b=[];j._renderPanelListBody(b,a,h,a.readonly?"browse":"edit"),j.$('[data-pid="'+a.id+'"] tbody').html(b.join(""))})}return this.setTitle()},setDefaults:function(){var a=this;return this.clear(),_.each(this.getFields(),function(b){b.hasOwnProperty("defaultValue")&&a.setFieldValue(b.id,b.defaultValue)}),this},setFieldValue:function(a,b){return this.$field(a).val(b),this},getFieldValue:function(a){if(_.isString(a))return e.getFieldVal(this._fieldHash[a],this.$field(a));var b=e.getFieldVal(a,this.$field(a.id));if(a.type===f.json){var c;try{c=$.parseJSON(b)}catch(a){}return _.isUndefined(c)?b:c}if(a.type===f.date){var d=e.getFieldVal(a,this.$field(a.id));return 10===d.length?d+"T08:00:00.000Z":d}return e.getFieldVal(a,this.$field(a.id))},setFieldProp:function(b,c,d){if("value"===c)this.setFieldValue(b,d);else{var e=this.$field(b);switch(c){case"enabled":d?e.removeProp("disabled"):e.prop("disabled",!0);break;case"visible":a.showOrHide(e,d)}}return this},getFieldProp:function(a,b){if("value"===b)this.setFieldValue(a,value);else{var c=this.$field(a);switch(b){case"enabled":return!c.prop("disabled");case"visible":return c.is(":visible");case"valid":}}},$field:function(a){return this.$("#"+this.fieldViewId(a))},clear:function(){var a,b,d=this,e=this.getSubCollecs();return this.clearMessages(),_.each(this.getFields(),function(e){if(a=d.$field(e.id),b=e.defaultValue||"",e.readonly)a.html(b);else switch(e.type){case f.bool:a.prop("checked",!!b&&"checked");break;case f.list:a.select2("val",b);break;case f.pix:var g="<p>"+c.nopix+"</p>";a.val("").prev().remove(),a.before(g);break;case f.formula:a.html("");break;default:a.val(b)}}),e&&_.each(e,function(a){d.$('[data-pid="'+a.id+'"] tbody').html(d._TRnodata(a.elements.length,"edit"))}),this},clearCache:function(){return this._fieldHash=null,this._fields=null,this._subCollecs=this._subCollecsOK=!1,this},getModelFieldValue:function(a,b,c){return this.model&&this.model.has(a)?"new"!==c?this.model.get(a):b||"":""},_showTab:function(a){var b=this.$(a);return b.length>0&&(b.siblings(".tab-pane").removeClass("active").hide(),b.addClass("active").show()),b=this.$('.evol-tabs > li > a[href="'+a+'"]').parent(),b.length>0&&(b.siblings("li").removeClass("active"),b.addClass("active").show()),this._tabId=a,this.$el.trigger("change.tab",{id:a}),this},_renderButtons:function(b,d){b.push(a.html.clearer+'<div class="evol-buttons panel '+this.style+'">'+a.button("cancel",c.tools.bCancel,"btn-default")+a.button("save",c.tools.bSave,"btn-primary")),this.model&&this.model.isNew()&&this.button_addAnother&&"json"!==d&&b.push(a.button("save-add",c.tools.bSaveAdd,"btn-default")),b.push("</div>")},_render:function(b,c){var d=this,e=-1,f=-1,g=this.uiModel.elements;b.push('<div class="evo-one-'+c+'">'),_.each(g,function(h,i){"tab"===h.type?(f>0&&(b.push("</div>"),f=-1),e<0&&(b.push(a.html.clearer),d._renderTabTitles(b,g),b.push('<div class="tab-content">')),e++,b.push('<div id="evol-tab-'+i+'" class="tab-pane'+(0===e?' active">':'" style="display:none;">')),d._renderTab(b,h,c)):(f<0&&(b.push('<div class="evol-pnls">'),f=1),h.id||(h.id="p"+i),"panel-list"===h.type?d._renderPanelList(b,h,c):d._renderPanel(b,h,c))}),e>0&&b.push("</div>"),f>0&&b.push("</div>"),b.push("</div>"),this._renderButtons(b,c)},_renderTabTitles:function(a,b){var c=!0;a.push('<ul class="nav nav-tabs evol-tabs">'),_.each(b,function(b,d){"tab"===b.type&&(c?(a.push('<li class="active '+(b.cssLabel||"")+'">'),c=!1):b.cssLabel?a.push('<li class="'+b.cssLabel+'">'):a.push("<li>"),a.push('<a href="#evol-tab-'+d+'">'+b.label+"</a></li>"))}),a.push("</ul>")},_renderTab:function(b,c,d){var e=this;b.push('<div class="evol-pnls '+(c.css||"")+'">'),_.each(c.elements,function(a,c){a.id||(a.id="p-"+c),"panel-list"===a.type?e._renderPanelList(b,a,d):e._renderPanel(b,a,d)}),b.push(a.html.clearer+"</div></div>")},_renderPanel:function(c,d,e,g){var h=this,i=this.iconsPath;if("wiz"===e){var j=!_.isUndefined(g)&&!g;c.push('<div data-p-width="100" class="evol-pnl evo-p-wiz" style="width:100%;'+(j?"display:none;":"")+'">')}else c.push('<div data-p-width="'+d.width+'" class="evol-pnl" style="width:'+d.width+'%">');return c.push(a.panelBegin(d,this.style||"panel-default",!0),'<fieldset data-pid="'+d.id+(d.readonly?'" disabled>':'"><div class="evol-fset">')),_.each(d.elements,function(a){"panel-list"==a.type?h._renderPanelList(c,a,a.readonly?"browse":e):a.type==f.hidden?c.push(b.hidden(h.fieldViewId(a.id),h.getModelFieldValue(a.id,a.defaultValue,e))):(c.push('<div style="width:'+parseInt(a.width||100,10)+'%" class="evol-fld">'),"panel"===a.type?h._renderPanel(c,a,e,i):h.renderField(c,a,e,i),c.push("</div>"))}),c.push("</div></fieldset>"+a.panelEnd()+"</div>"),this},_renderPanelList:function(b,c,e){function f(b,c){c.type===i.pix?b.push('<th class="evo-col-pix">'):b.push("<th>"),b.push(c.label+(g&&c.required?a.html.required:"")+"</th>")}var g=!c.readonly&&"browse"!==e,h=g?e:"browse",i=d.fieldTypes;if(b.push('<div style="width:'+c.width+'%" class="evol-pnl" data-pid="'+c.id+'">',a.panelBegin(c,this.style,!0),'<div class="evo-plist"><table class="table" data-mid="'+(c.attribute||c.id)+'"><thead><tr>'),_.isArray(c.elements))_.each(c.elements,function(a){f(b,a)});else if(_.isObject(c.elements))for(var j in c.elements)f(b,elements[j]);return"edit"===h&&b.push("<th></th>"),b.push("</tr></thead><tbody>"),this._renderPanelListBody(b,c,null,h),b.push("</tbody></table></div>",a.panelEnd(),"</div>"),this},_renderPanelListBody:function(b,c,d,g){var h=this,i=c.elements,j=this.iconsPath||"",k="edit"===g&&!c.readonly;if(this.model){var l=this.model.get(c.attribute);if(l&&l.length>0){var m='<td class="evo-td-plusminus">'+a.buttonsPlusMinus()+"</td>";return void _.each(l,function(a,d){b.push('<tr data-idx="'+d+'">'),k?b.push(h._TDsFieldsEdit(c.elements,a)+m):_.each(i,function(c){b.push("<td>"),a[c.id]?c.type===f.bool||c.type===f.lov||c.type===f.pix?b.push(e.fieldHTML_RO(c,a[c.id],Evol.hashLov,j)):b.push(_.escape(e.fieldHTML_RO(c,a[c.id],Evol.hashLov,j))):b.push(_.escape(e.fieldHTML_RO(c,"",Evol.hashLov,j))),b.push("</td>")}),b.push("</tr>")})}}b.push(this._TRnodata(i.length||1,g))},_TRnodata:function(b,d){return'<tr data-id="nodata"><td colspan="'+("edit"===d?b+1:b)+'" class="evol-pl-nodata">'+c.nodata+("edit"===d?a.buttonsPlus():"")+"</td></tr>"},_TDsFieldsEdit:function(a,b){var c,d="",f=this.iconPath;return _.each(a,function(a){c=b[a.id],_.isUndefined(c)&&(c=""),d+="<td>"+e.fieldHTML(a,a.id,c,"edit-details",f,!0)+"</td>"}),d},renderField:function(b,c,d,g,h){var i="";return this.model&&this.model.has(c.id)&&(i="new"!==d?this.model.get(c.id):c.defaultValue||""),c.type===f.formula?(h||b.push(Evol.Dico.HTMLFieldLabel(c,d||"edit")),b.push(a.input.formula(this.fieldViewId(c.id),c,this.model))):c.type!==f.json||"browse"!==d&&!c.readOnly?b.push(e.fieldHTML(c,this.fieldViewId(c.id),i,d,g,h)):(h||b.push(Evol.Dico.HTMLFieldLabel(c,d)),b.push(a.input.textM(this.fieldViewId(c.id),Evol.Format.jsonString(i,!1),c.maxLen,c.height,!0))),this},getTitle:function(){if(this.model){if(this.model.isNew&&this.model.isNew())return c.getLabel("tools.newEntity",this.uiModel.name);var a=this.uiModel.fnTitle;return _.isFunction(a)?a(this.model):this.model.get(a)}return Evol.Format.capitalize(this.uiModel.name)},setTitle:function(a){var b=this.uiModel.fnBadge;return b&&(b=_.isString(b)?this.model.escape(b)||"":b(this.model)),e.setViewTitle(this,a,b)},validate:function(a){var b,d=a?a:this.getFields(),e=this.getData(!0),f=[];if(this.clearMessages(),f=this._checkFields(d,e),b=""===f,this._subCollecs){var g=this;_.each(this._subCollecs,function(a){var d=e[a.id],h=g.$('[data-pid="'+a.id+'"] tbody > tr'),i=0;if(_.each(d,function(b,c){_.each(a.elements,function(a){g.validateField(a,"date"===a.type?b[a.id]?b[a.id].substring(0,10):"":b[a.id])&&(h.eq(c).find("#"+a.id).parent().addClass("has-error"),i++)})}),i>0){var j="validation.invalidList"+(1===i?"1":"");j=c.getLabel(j,i,a.label),f.push(j),b=!1}})}return this.$el.trigger("action","validate",{valid:b}),f},valRegEx:{email:/^[\w\.\-]+@[\w\.\-]+\.[\w\.\-]+$/,integer:/^[-+]?\d+$/,decimalEN:/(\+|-)?(\d*\.\d*)?$/},_checkFields:function(a,b){function c(a,b){_.isArray(g)&&g.push(b);var c=e.$field(a.id).parent();a.type===f.email&&(c=c.parent());var d=c.find(".text-danger");d.length?d.html(b):c.append('<p class="text-danger">'+b+"</p>"),c.addClass("has-error")}var d,e=this,g=[];return _.each(a,function(a){d=e.validateField(a,b[a.id]),""!==d&&c(a,d)}),g},validateField:function(a,b){function e(a,b,c,d){return b.replace("{0}",a).replace("{1}",c).replace("{2}",d)}function g(a){return a.label||a.labelMany}var h=c.validation,i=d.fieldIsNumber(a);if(!a.readonly){if(a.required&&(""===b||i&&isNaN(b)||a.type===f.lov&&"0"===b||a.type===f.list&&b&&0===b.length))return e(a.label,h.empty);if(!(isNaN(b)&&i||""===b||_.isArray(b)))switch(a.type){case f.int:case f.email:if(!this.valRegEx[a.type].test(b))return e(g(a),h[a.type]);break;case f.dec:case f.money:var j=this.valRegEx[f.dec+c.LOCALE]||this.valRegEx[f.dec+"EN"];if(!j.test(b))return e(g(a),h[a.type]);break;case f.date:case f.datetime:case f.time:if(""!==b&&!_.isDate(new Date(b)))return e(g(a),h[a.type]);break;case f.json:var k;if(_.isObject(b))k=b;else{try{k=$.parseJSON(b)}catch(a){}if(_.isUndefined(k))return e(g(a),h[a.type])}}if(null!==a.regExp&&!_.isUndefined(a.regExp)){var l=new RegExp(a.regExp);if(!b.match(l))return e(g(a),h.regExp,g(a))}if(i&&""!==b){if(a.max&&parseFloat(b)>a.max)return e(g(a),h.max,a.max);if(a.min&&parseFloat(b)<a.min)return e(g(a),h.min,a.min)}if(a.fnValidate){var m=a.fnValidate(a,b);if(""!==m)return e(g(a),m)}if(_.isString(b)){var n=b.length,o=!!a.maxLength&&n>a.maxLength,p=!!a.minLength&&n<a.minLength;if(o||p)return a.maxLength&&a.minLength?e(g(a),h.minMaxLength,a.minLength,a.maxLength):a.maxLength?e(g(a),h.maxLength,a.maxLength):e(g(a),h.minLength,a.minLength)}}return""},clearErrors:function(){return this.$(".control-group.error").removeClass("control-group error"),this.$(".has-error").removeClass("has-error"),this.$(".text-danger").remove(),this},fieldViewId:function(a){return this.prefix+"-"+a},showHelp:function(a,b,c,d){var e,f,g=_.findWhere(this.getFields(),{id:a});return g&&g.help&&(e=c.closest(".evol-fld"),"mini"===this.viewName&&(e=e.find(".evol-mini-content")),f=d?[]:e.find(".help-block"),f.length>0?f.slideUp(200,function(){f.remove()}):(f=$('<span class="help-block">'+_.escape(g.help)+"</span>").hide(),e.append(f),f.slideDown(200))),this},clearMessages:function(){return this.$el.trigger("message",null),this.clearErrors()},sendMessage:function(a,b,c){return this.$el.trigger("message",{title:a,content:b,style:c})},setTab:function(a){this._showTab(a)},getTab:function(){return this._tabId},click_button:function(a){var b=$(a.currentTarget).data("id");a.stopImmediatePropagation(),"save"===b?this.validate()&&this.$el.trigger("action",b):this.$el.trigger("action",b)},click_toggle:function(a){var b=$(a.currentTarget),c=b.closest(".panel-heading").next(),d=c.data("expState"),e="glyphicon-chevron-up",f="glyphicon-chevron-down";if(a.preventDefault(),a.stopImmediatePropagation(),a.shiftKey){var g="down"===d?f:e;this.$(".evol-title-toggle."+g).trigger("click")}else"down"===d?(b.closest(".panel").css("height",""),c.slideDown(300).data("expState","up"),b.addClass(e).removeClass(f)):(c.slideUp(300,function(){b.closest(".panel").css("height","40px")}).data("expState","down"),b.removeClass(e).addClass(f));this.$el.trigger("toggle.panel")},click_tab:function(a){var b=a.currentTarget.href,c=b.substring(b.indexOf("#"));a.stopImmediatePropagation(),a.preventDefault(),a.shiftKey?this.$(".tab-content > div").show():this._showTab(c),this._tabId=c},click_help:function(a){var b="none",c=$(a.currentTarget),d=c.data("type");if(a.stopImmediatePropagation(),a.shiftKey){var e=this,f=!this._allHelp;f&&(this.$(".evol-fld>.help-block").remove(),this._allHelp=!0,b="all"),_.each(this.getFields(),function(a){if(a.help){var b=e.$field(a.id);e.showHelp(a.id,a.type,b,f)}}),this.$el.trigger(d+".help",{id:b})}else b=c.closest("label").attr("for"),this.showHelp(b,d,c),this.$el.trigger(d+".help",{id:b})},click_detailsAddDel:function(b){var c=$(b.currentTarget),d=c.data("id"),e=c.closest("tr");if(!b.keyCode||13===b.keyCode)if(b.stopImmediatePropagation(),"bPlus"===d){var f="",g=this.getSubCollecs(),h=e.closest("table").data("mid"),i=g[h]?g[h].elements:null;f+="<tr>"+this._TDsFieldsEdit(i,{})+'<td class="evo-td-plusminus">'+a.buttonsPlusMinus()+"</td></tr>",$(f).insertAfter(e),"nodata"===e.data("id")&&e.remove()}else"bMinus"===d&&(0===e.siblings().length&&$(this._TRnodata(e.children().length,"edit")).insertAfter(e),e.remove())}})}(),Evol.ViewOne.Browse=Evol.View_One.extend({viewName:"browse",editable:!1,icon:"eye-open",prefix:"ovw",getData:function(){return{}},setData:function(a){if(!_.isUndefined(a)&&null!==a){var b,c,d=this,e=Evol.DOM.input,f=Evol.Def.fieldTypes,g=Evol.Dico.fieldHTML_RO,h="#"+d.prefix+"-",i=this.getSubCollecs(),j=this.iconsPath||"";_.each(this.getFields(),function(i){if(b=d.$(h+i.id),c=i.value?i.value(a):a.get(i.attribute||i.id),a)switch(i.type){case f.lov:case f.list:case f.bool:case f.email:case f.url:case f.html:b.html(g(i,c,Evol.hashLov,j));break;case f.formula:b.html(i.formula?i.formula(a):"");break;case f.pix:b.html(c?'<img src="'+j+c+'" class="img-thumbnail">':"<p>"+Evol.i18n.nopix+"</p>");break;case f.color:b.html(e.colorBox(i.id,c,c));break;case f.textml:c?b.html(_.escape(c).replace(/[\r\n]/g,"<br>")):b.html("");break;case f.json:b.val(Evol.Format.jsonString(c,!1));break;default:b.text(g(i,c,Evol.hashLov,j)||" ")}}),i&&_.each(i,function(a){var b=[];d._renderPanelListBody(b,a,c,"browse"),d.$('[data-pid="'+a.id+'"] tbody').html(b.join(""))})}return this.setTitle()},clear:function(){var a,b=this,c=Evol.Def.fieldTypes,d="#"+b.prefix+"-",e=this.getSubCollecs();return this.clearMessages(),_.each(this.getFields(),function(e){switch(a=b.$(d+e.id),e.type){case c.bool:a.prop("checked",!!e.defaultValue&&"checked");break;case c.pix:break;default:a.html(e.defaultValue||"")}}),e&&_.each(e,function(a){b.$('[data-pid="'+a.id+'"] tbody').html(b._TRnodata(a.elements.length,"browse"))}),this},_renderButtons:function(a){a.push(Evol.DOM.html.clearer+'<div class="evol-buttons panel '+this.style+'">'+Evol.DOM.button("cancel",Evol.i18n.tools.bCancel,"btn-default")+Evol.DOM.button("edit",Evol.i18n.tools.bEdit,"btn-primary")+"</div>")}}),Evol.ViewOne.Edit=Evol.View_One.extend({viewName:"edit",icon:"edit",prefix:"oe",postRender:function(){var a="#"+this.prefix+"-",b=_.filter(this.getFields(),function(a){return"list"===a.type&&!a.readonly});_.each(b,function(b){this.$(a+b.id).select2({data:b.list,multiple:!0})})}}),Evol.ViewOne.JSON=Evol.View_One.extend({events:{"click > .evol-buttons > button":"click_button","click .evol-title-toggle":"click_toggle"},viewName:"json",icon:"barcode",render:function(){var a=Evol.DOM;if(this.model){var b=[],c=JSON.stringify(this.model,null,2);b.push(a.panelBegin({id:"p-json",label:Evol.Format.capitalize(this.uiModel.name),label2:"JSON"},this.style+" evo-p-json",!0)+"<fieldset>"+a.label("uimjson","JSON")+a.input.textMJSON("uimjson",c,16)+"</fieldset>"+a.panelEnd()),this._renderButtons(b,"json"),this.$el.html(b.join(""))}else this.$el.html(a.HTMLMsg(Evol.i18n.nodata,"","info"));return this.setData(this.model),this},validate:function(){var a=!0,b=this.getData(),c=this._getDOMField().parent();return a=!Evol.DOM.addRemClass(c,null===b,"has-error"),this.$el.trigger("action","validate",{valid:a}),a?[]:[Evol.i18n.validation.invalid]},getData:function(){var a,b=this._getDOMField().val();if(""===b)return b;try{a=$.parseJSON(b)}catch(b){a=null}return a},setData:function(a){return this.clearError()._getDOMField().val(JSON.stringify(a.toJSON(),null,2)),this.setTitle()},clear:function(){return this._getDOMField().val(""),this},clearError:function(){return this._getDOMField().parent().removeClass("has-error"),this},_getDOMField:function(){return this.$("textarea")}}),Evol.ViewOne.Mini=function(){var a=Evol.DOM,b=Evol.Def.fieldTypes;return Evol.ViewOne.Edit.extend({events:{"click > .evol-buttons > button":"click_button","click .evol-title-toggle":"click_toggle","click label > .glyphicon-question-sign":"click_help"},viewName:"mini",icon:"th-large",prefix:"om",fieldsetFilter:function(a){return a.required||a.inMany||a.inMini},_render:function(a,b){var c={id:"p-mini",type:"panel",class:"evol-mini-holder",label:Evol.Format.capitalize(this.uiModel.name),width:100,elements:this.getFields()};this._renderPanel(a,c,b),
this._renderButtons(a,b)},_renderPanel:function(c,d,e,f){var g=this,h=this.iconsPath;return c.push('<div data-p-width="100%" class="evol-pnl evol-p-mini">'+a.panelBegin(d,this.style,!0)+'<fieldset data-pid="'+d.id+(d.readonly?'" disabled>':'">')),_.each(d.elements,function(d){d.type==b.hidden?c.push(a.input.hidden(g.fieldViewId(d.id),g.getModelFieldValue(d.id,d.defaultValue,e))):(c.push('<div class="pull-left evol-fld w-100"><div class="evol-mini-label">'+Evol.Dico.HTMLFieldLabel(d,e)+'</div><div class="evol-mini-content">'),g.renderField(c,d,e,h,!0),c.push("</div></div>"))}),c.push("</fieldset>"+a.panelEnd()+"</div>"),this}})}(),Evol.ViewAction.Export=function(){var a=Evol.DOM,b=Evol.Dico,c=Evol.Def.fieldTypes,d=a.input,e=Evol.i18n,f=e.export;return Backbone.View.extend({viewName:"export",cardinality:"n",icon:"cloud-download",events:{"change .evol-xpt-format":"click_format","change input, .evol-xpt-db":"_preview","change #xpt-header":"_preview","click .evol-xpt-more":"click_toggle_sel","click button":"click_button"},options:{model:null,uiModel:null,many:!0,sampleMaxSize:20,formats:["CSV","TAB","JSON","HTML","XML","SQL"]},initialize:function(a){return _.extend(this,this.options,a),this},render:function(){return this.$el.html(this._renderHTML()),this._preview(this.formats[0]),this},_renderHTML:function(){function b(){var a,b,c=i.length,d=c>14,e='<fieldset class="checkbox"><label><input type="checkbox" value="1" id="showID">'+f.IDkey+"</label>";return _.each(i,function(c,g){a=c.labelExport||c.label||c.labelList,b="fx-"+c.id,null!==a&&""!==a||(a="("+b+")"),e+='<label><input type="checkbox" value="1" id="'+b+'" checked="checked">'+a+"</label>",10===g&&d&&(e+='<a href="javascript:void(0)" class="evol-xpt-more">'+f.allFields+'</a><div style="display:none;">')}),d&&(e+="</div>"),e+="</fieldset>"}function c(b){var c='<div class="evol-xpt-opts"><div class="evol-FLH clearfix"><label class="evol-xpt-cb1">'+d.checkbox(b,!0)+f.firstLine+"</label>"+d.select("xpt-header","","evol-xpt-header",!1,[{id:"label",text:f.headerLabels},{id:"attribute",text:f.headerIds}])+'</div><div id="xptCSV" class="evol-xpt-opt"><div data-id="csv2" class="evol-w120">'+a.fieldLabel("separator",f.separator)+d.text("separator",",","0")+"</div></div>";return _.each(h,function(a){c+='<div id="xpt'+a+'" style="display:none;">&nbsp;</div>'}),c+="</div></div>"+a.html.clearer}var g="",h=this.formats,i=this.getFields(),j=a.button("export",f.DownloadEntity.replace("{0}",this.uiModel.namePlural),"btn btn-primary");g+='<div class="evol-xpt panel '+this.style+'">'+a.panelHeader({label:this.getTitle()},!1)+'<div class="evol-xpt-form clearfix"><div class="evol-xpt-flds"><div><label>'+f.xpFields+"</label></div>"+b()+'</div><div class="evol-xpt-para">';var k="evol-xpt-format",l=_.map(h,function(a){return{id:a,text:f["format"+a]}});return g+='<div class="evol-xptf"><div class="evol-xpt-format-hld"><label for="'+k+'">'+f.format+"</label>"+d.select(k,"","evol-xpt-format",!1,l)+"</div>",g+='<div class="top-btn-xpt">'+j+"</div>",g+=c("xptFLH")+'<label class="evol-xpt-pvl">'+f.preview+'</label><textarea class="evol-xpt-val form-control"></textarea></div></div></div><div class="panel '+this.style+' evol-buttons form-actions">'+a.button("cancel",e.tools.bCancel,"btn-default")+j+"</div></div>"},setModel:function(a){this.model=a},showFormatOpts:function(b){"TAB"===b?(b="CSV",this.$('[data-id="csv2"]').hide()):"CSV"===b?this.$('[data-id="csv2"]').show():this.$("#xpt"+b).html(this._formatOptions(b,this.uiModel.name));var c=this.$("#xpt"+b).show().siblings().hide();return a.showOrHide(c.filter(".evol-FLH"),"TAB"===b||"CSV"===b||"HTML"===b),this},getFields:function(){return this.fields||(this.fields=Evol.Def.getFields(this.uiModel,function(a){return a.type!=c.formula&&a.type!=c.json&&(_.isUndefined(a.inExport)||a.inExport)})),this.fields},getTitle:function(){return this.many?e.getLabel("export.exportMany",this.uiModel.namePlural):e.getLabel("export.exportOne",this.uiModel.name)},setTitle:function(){b.setViewTitle(this)},_preview:function(){this.$(".evol-xpt-val").val(this.exportContent(this.val()))},exportContent:function(a){var d="",f=a.options,g=this.sampleMaxSize-1;if(this.collection||this.model&&this.model.collection){var h=this.collection?this.collection.models:this.model.collection.models,i={};_.each(a.fields,function(a){i[a]=""});var j,k=_.filter(this.getFields(),function(a){if(a.id&&_.has(i,a.id))return!0}),l=k.length-1;switch(f.firstLineHeader&&(j="label"===f.header?function(a){var b=a.labelExport||a.label||a.id;return b.indexOf(",")>-1?'"'+b+'"':b}:function(a){return a.attribute||a.id}),a.format){case"CSV":case"TAB":case"TXT":var m=Evol.Format.trim(this.$("#separator").val());"TAB"==a.format&&(m="\t"),f.firstLineHeader&&(f.showID&&(d+="ID"+m),_.each(k,function(a,b){d+=j(a),b<l&&(d+=m)}),d+="\n"),_.every(h,function(a,b){return f.showID&&(d+=(a.id||"m"+b)+m),_.each(k,function(b,e){var f=a.get(b.id);f&&(d+=b.type===c.bool?f:(b.type==c.text||b.type==c.textml)&&f.indexOf(",")>-1?f?'"'+f.replace('"','\\"')+'"':'""':b.type==c.list?f?'"'+f+'"':'""':f),e<l&&(d+=m)}),d+="\n",b<g}),d+="\n";break;case"HTML":d="<table>\n",f.firstLineHeader&&(d+="<tr>\n",f.showID&&(d+="<th>ID</th>"),_.each(k,function(a){d+="<th>"+j(a)+"</th>"}),d+="\n</tr>\n"),_.every(h,function(a,b){return d+="<tr>\n",f.showID&&(d+="<td>"+a.id+"</td>"),_.each(k,function(b){var c=a.get(b.id);d+=_.isUndefined(c)||""===c?"<td></td>":"<td>"+c+"</td>"}),d+="\n</tr>\n",b<g}),d+="</table>\n";break;case"JSON":var n=_.map(k,function(a){return a.id});f.showID&&n.unshift("id"),d=[],_.every(h,function(a,b){return d.push(JSON.stringify(_.pick(a.toJSON(),n),null,2)),b<g}),d=this.many?"["+d.join(",\n")+"]":d.join("");break;case"SQL":var o,p,q,r,s,t,u=!1,v="\n",w=f.table.replace(/ /g,"_"),x="INSERT INTO "+w+" (";switch(f.database){case"sqlserver":o=function(a){return _.isUndefined(a)||_.isObject(a)?'""':'"'+a.replace(/"/g,'""')+'"'},r="NULL",q='""',s="BEGIN TRANSACTION",t="COMMIT TRANSACTION",u=f.showID;break;default:o=function(a){return _.isUndefined(a)||_.isObject(a)?'""':"'"+a.replace(/'/g,"''")+"'"},r="null",q="''",s="BEGIN;",t="COMMIT;"}p=function(a){return _.isUndefined(a)||null===a?r:""===a?q:_.isNumber(a)?a:o(a)},f.showID&&(x+="ID, "),_.each(k,function(a,b){x+=a.id,b<l&&(x+=", ")}),x+=")\n VALUES (",f.transaction&&(d+=s+v),u&&(d+="SET IDENTITY_INSERT "+w+" ON;"+v);var y;_.every(h,function(a,e){return d+=x,f.showID&&(d+=p(a.id)+", "),_.each(k,function(e,f){switch(y=a.get(e.id),e.type){case c.int:case c.dec:case c.money:d+=y?y:r;break;case c.bool:d+="boolean"==typeof y?y:r;break;case c.date:case c.datetime:case c.time:d+=_.isUndefined(y)||""===y?r:p(y);break;case c.list:d+=_.isUndefined(y)||""===y||_.isArray(y)&&0===y.length?r:_.isNumber(y)?y:p(b.fieldHTML_RO(e,y,Evol.hashLov,""));break;default:d+=_.isUndefined(y)||""===y?q:_.isNumber(y)?y:p(y)}f<l&&(d+=", ")}),d+=");\n",e<g}),u&&(d+="SET IDENTITY_INSERT "+w+" OFF;"+v),f.transaction&&(d+=t+v);break;case"XML":var z,A=f.elementName;d="<xml>\n",_.every(h,function(a,b){return d+="<"+A+" ",f.showID&&(d+='ID="'+a.id+'" '),_.each(k,function(b){d+=b.id+'="',b.type===c.text||b.type===c.textml?(z=a.get(b.id),_.isArray(z)||_.isUndefined(z)||""===z||(d+=z.replace(/"/g,'\\"'))):d+=a.get(b.id),d+='" '}),d+="></"+A+">\n",b<g}),d+="</xml>"}}else d+=e.nodata;return d},fieldHTML:function(b,c,e){return a.fieldLabel(b,c)+d.text(b,e.replace(/ /g,"_"),null,"xpt-mw300")},val:function(a){if(_.isUndefined(a)){for(var b=this.$(".evol-xpt-format").val(),c=this.uiModel.label||Evol.Format.capitalize(this.uiModel.entities),d={title:c,format:b,fields:this._valFields(),options:{}},e=this.$("#xpt"+b+" input"),f=0,g=e.length;f<g;f++){var h,i=e.eq(f);h="checkbox"===i.attr("type")?i.prop("checked"):i.val(),d.options[i.attr("id")]=h}return"CSV"===d.format||"TAB"===d.format||"HTML"===d.format?(d.options.firstLineHeader=this.$("#xptFLH").prop("checked"),d.options.firstLineHeader&&(d.options.header=this.$("#xpt-header").val()),"TAB"===d.format&&delete d.options.separator):"SQL"===d.format&&(d.options.database=this.$(".evol-xpt-db").val()||this.uiModel.table||this.uiModel.id),d.options.showID=this.$("#showID").prop("checked"),d}return this},_valFields:function(){var a=[],b=this.$(".evol-xpt-flds input:checked");return _.each(b,function(b){a.push(b.id.substr(3))}),a},_formatOptions:function(a,b){return"XML"===a?"<div>"+this.fieldHTML("elementName",f.XMLroot,b)+"</div>":"SQL"===a?'<div><label for="xpt-db">'+f.db+"</label> "+d.select("xpt-db","postgres","evol-xpt-db",null,[{id:"postgres",text:"PostgreSQL"},{id:"sqlserver",text:"SQL Server"}])+'<div class="evo-inline-holder"><div>'+this.fieldHTML("table",f.SQLTable,b)+"</div><div><label>"+d.checkbox("transaction",!1)+f.SQLTrans+"</label></div></div></div>":"&nbsp;"},click_format:function(a){var b=$(a.currentTarget).val();"XML"===b&&this.$("#XML").html(this._formatOptions("XML",this.uiModel.name)).show().siblings().not(".evol-FLH").hide(),this.showFormatOpts(b)._preview(),this.$el.trigger("change.export","format",b)},click_toggle_sel:function(a){$(a.currentTarget).hide().next().slideDown()},change_header:function(a){this._preview()},click_button:function(a){var b=$(a.currentTarget).data("id");"export"===b&&this.download(this.val()),this.$el.trigger("action",b)},download:function(a){var b=new Blob([this.$(".evol-xpt-val").val()],{type:"text/plain"}),c="TAB"===a.format?"txt":a.format.toLowerCase(),d=a.title.replace(/ /g,"_")+"."+c,e=document.createElement("a");e.download=d,e.href=window.URL.createObjectURL(b),document.body.appendChild(e),e.click(),e.remove&&e.remove()}})}(),Evol.ViewAction.Filter=function(){var a=Evol.DOM,b=a.input,c=Evol.Def.fieldTypes,d=Evol.i18n.filters,e={sEqual:"eq",sNotEqual:"ne",sStart:"sw",sContain:"ct",sNotContain:"nct",sFinish:"fw",sInList:"in",sIsNull:"null",sIsNotNull:"nn",sGreater:"gt",sSmaller:"lt",sBetween:"bw"};return Backbone.View.extend({viewName:"filter",events:{"click .evo-bNew":"click_new","click .evo-bAdd":"click_add","click .evo-bSubmit":"click_submit","click .evo-zfilters>a>button":"click_remove","click .close":"click_close"},options:{fields:[],dateFormat:"mm/dd/yyyy",buttonLabels:!1,submitButton:!1,submitReady:!1},initialize:function(a){return _.extend(this,this.options,a),this.fields.length<1&&this.uiModel&&(this.fields=_.map(Evol.Def.getFields(this.uiModel,function(a){return a.type!==c.hidden}),function(a){return a.type!==c.list?a:_.extend({},a,{type:c.lov,trueType:c.list})})),this},render:function(){var b=this.buttonLabels,d=this,f=this.$el,g="";return g+=a.html.buttonClose+'<div class="evo-zfilters"></div><a class="evo-bNew btn btn-primary btn-group-sm glyphicon glyphicon-plus" href="javascript:void(0)"></a>',this.submitButton&&(g+='<a class="evo-bSubmit btn btn-primary glyphicon glyphicon-ok" href="javascript:void(0)"></a>'),g+='<div class="evo-editFilter"></div><a class="evo-bAdd btn btn-primary glyphicon glyphicon-ok" style="display:none;" href="javascript:void(0)"></a><a class="evo-bDel btn btn-default glyphicon glyphicon-remove" style="display:none;" href="javascript:void(0)"></a>',f.html(g),this._step=0,this.submitReady&&(this._hValues=$("<span></span>").appendTo(f)),this.submitButton&&(this._bSubmit=f.find(".evo-bSubmit").button({text:b})),this._bNew=f.find(".evo-bNew").button({text:b,icons:{secondary:"ui-icon-plusthick"}}),this._bAdd=f.find(".evo-bAdd").button({text:b,icons:{secondary:"ui-icon-check"}}),this._bDel=f.find(".evo-bDel").button({text:b,icons:{secondary:"ui-icon-close"}}).on("click",function(a){d._removeEditor()}),this._editor=f.find(".evo-editFilter").on("change","#field",function(a){a.stopPropagation(),d._step>2&&d._editor.find("#value,#value2,.as-Txt").remove(),d._step>1&&(d._editor.find("#operator").remove(),d._bAdd.hide()),d._step=1;var b=$(a.currentTarget).val();if(""!==b){d._field=d._getFieldById(b);var e=d._type=d._field.type;d._setEditorOperator(),e!==c.lov&&e!==c.bool||d._setEditorValue()}else d._field=d._type=null}).on("change","#operator",function(a){a.stopPropagation(),d._operator=$(this).val(),d._step>2&&(d._editor.find("#value,#value2,.as-Txt").remove(),d._bAdd.hide(),d._step=2),d._setEditorValue()}).on("change keyup","#value,#value2",function(a){a.stopPropagation();var b=d._type,f=$(this).val(),g=""!==f||b===c.lov||b===c.bool;"number"==b?g=g&&!isNaN(f):d._operator==e.sBetween&&(g=""!==d._editor.find("#value").val()&&""!==d._editor.find("#value2").val()),g?(d._bAdd.button("enable"),13===a.which&&d._bAdd.trigger("click")):d._bAdd.button("disable")}).on("click","#checkAll",function(){var b=$(this);a.toggleCheckbox(b.siblings(),b.prop("checked"))}),this._filters=f.find(".evo-zfilters").on("click","a",function(){d._editCond($(this))}).on("click","a>button",function(a){a.stopPropagation();var b=$(this).parent();b.hasClass("ui-state-disabled")||(b.fadeOut("slow",function(){b.remove(),d._triggerChange()}),d._removeEditor())}),this},_getFieldById:function(a){return this._hash||(this._hash=Evol.Def.getFieldsHash(this.fields)),this._hash[a]},_removeEditor:function(){this._editor.empty(),this._bAdd.hide(),this._bDel.hide(),this._enableCond(null,!1),this._bNew.removeClass("ui-state-active").show().focus(),this._bSubmit&&this._bSubmit.removeClass("ui-state-active").show(),this._step=0,this._field=this._type=this._operator=null},addCondition:function(a){$('<a href="javascript:void(0)">'+this._htmlCond(a)+"</a>").prependTo(this._filters).data("filter",a).fadeIn();return this._triggerChange(),this},removeCondition:function(a){return this._filters.children().eq(a).remove(),this._triggerChange(),this},_htmlCond:function(b){var c='<span class="evo-lBold">'+b.field.label+'</span> <span class="evo-lLight">'+b.operator.label+'</span> <span class="evo-lBold">'+b.value.label+"</span>";return b.operator.value==e.sBetween&&(c+='<span class="evo-lLight"> '+d.opAnd+' </span><span class="evo-lBold">'+b.value.label2+"</span>"),c+=a.html.buttonClose},_enableCond:function(a,b){this._cFilter&&(this._cFilter.removeClass("disabled"),a?(this._cFilter.data("filter",a).html(this._htmlCond(a)),this._cFilter=null,this._triggerChange()):this._cFilter=null)},_editCond:function(a){var b=a.data("filter"),c=b.field.value,f=b.operator.value,g=b.value;this._enableCond(null,!1),this._removeEditor(),this._cFilter=a.addClass("disabled"),this._setEditorField(c),this._setEditorOperator(f),f==e.sBetween?this._setEditorValue(g.value,g.value2):this._setEditorValue(g.value),this._bAdd.find(".ui-button-text").html(d.bUpdateFilter),this._step=3},_setEditorField:function(a){if(this._step<1){if(this._bNew.stop().hide(),this._bSubmit&&this._bSubmit.stop().hide(),this._bDel.show(),!this._fList){for(var c,d=this.fields,e='<select id="field" class="form-control"><option value=""></option>',f=0,g=d.length;f<g;f++)c=d[f],e+=b.option(c.id,c.label||c.labelList||"("+c.id+")");e+="</select>",this._fList=e}$(this._fList).appendTo(this._editor).focus()}a&&(this._field=this._getFieldById(a),this._type=this._field.type,this._editor.find("#field").val(a)),this._step=1},_setEditorOperator:function(a){var f=b.option,g=this._type;if(this._step<2){var h="";switch(g){case c.lov:h+=b.hidden("operator",e.sInList),this._operator=e.sInList;break;case c.bool:h+=b.hidden("operator",e.sEqual),this._operator=e.sEqual;break;default:switch(h+=b.selectBegin("operator","",!0),g){case c.date:case c.datetime:case c.time:h+=g==c.time?f(e.sEqual,d.sAt)+f(e.sNotEqual,d.sNotAt):f(e.sEqual,d.sOn)+f(e.sNotEqual,d.sNotOn),h+=f(e.sGreater,d.sAfter)+f(e.sSmaller,d.sBefore);break;case c.int:case c.dec:case c.money:h+=f(e.sEqual,d.sNumEqual)+f(e.sNotEqual,d.sNumNotEqual)+f(e.sGreater,d.sGreater)+f(e.sSmaller,d.sSmaller);break;default:h+=f(e.sStart,d.sStart)+f(e.sEqual,d.sEqual)+f(e.sNotEqual,d.sNotEqual)+f(e.sContain,d.sContain)+f(e.sNotContain,d.sNotContain)+f(e.sFinish,d.sFinish)}h+=f(e.sIsNull,d.sIsNull)+f(e.sIsNotNull,d.sIsNotNull)+"</select>"}this._editor.append(h)}a&&g!=c.lov&&(this._editor.find("#operator").val(a),this._operator=a),this._step=2},_setEditorValue:function(a,f){var g=this._editor,h=this._type,i=g.find("#operator").val(),j=!1,k=!0;if(""!==i){if(h==c.lov||i!=e.sIsNull&&i!=e.sIsNotNull){if(this._step<3){var l="";switch(j=i==e.sBetween,h){case c.lov:l+='<section id="value">'+(this._field.list.length>7?'(<input type="checkbox" id="checkAll" value="1"><label for="checkAll">All</label>) ':"")+b.checkboxLOV(this._field.list)+"</section>";break;case c.bool:l+='<span id="value">'+b.radio("value","1",d.yes,"0"!=a,"value1")+b.radio("value","0",d.no,"0"==a,"value0")+"</span>";break;case c.date:case c.datetime:case c.time:case c.int:case c.dec:case c.money:var m=h==c.date?"text":h;l+='<input id="value" type="'+m+'" class="form-control">',j&&(l+='<span class="as-Txt">'+d.opAnd+' </span><input id="value2" type="'+m+'" class="form-control">'),k=!1;break;default:l+='<input id="value" type="text" class="form-control">',k=!1}g.append(l),h==c.date&&g.find("#value,#value2").datepicker({dateFormat:this.dateFormat})}if(a){var n=g.find("#value");switch(h){case c.lov:n.find("#"+a.split(",").join(",#")).prop("checked","checked");break;case c.bool:n.find("#value"+a).prop("checked","checked");break;default:n.val(a),k=""!==a,j&&(n.next().next().val(f),k=""!==a&&""!==f)}}else k=h==c.lov||h==c.bool}else g.append(b.hidden("value",""));this._bAdd.button(k?"enable":"disable").show(),this._step=3}},_getEditorData:function(){function a(a){var b=p.split("/");return b.length>2?b[2]+"-"+b[0]+"-"+b[1]:a}var b=this._editor,f=b.find("#field"),g=b.find("#value"),h={field:{label:f.find("option:selected").text(),value:f.val()},operator:{},value:{}},i=h.operator,j=h.value;if(this._type==c.lov){var k=[],l=[];g.find("input:checked").not("#checkAll").each(function(){k.push(this.value),l.push(this.nextSibling.innerHTML)}),0===k.length?(i.label=d.sIsNull,i.value=e.sIsNull,j.label=j.value=""):1==k.length?(i.label=d.sEqual,i.value=e.sEqual,j.label='"'+l[0]+'"',j.value=k[0]):(i.label=d.sInList,i.value=e.sInList,j.label="("+l.join(", ")+")",j.value=k.join(","))}else if(this._type==c.bool){i.label=d.sEqual,i.value=e.sEqual;var m=g.find("#value1").prop("checked")?1:0;j.label=1==m?d.yes:d.no,j.value=m}else{var n=b.find("#operator"),o=n.val();if(i.label=n.find("option:selected").text(),i.value=o,o==e.sIsNull||o==e.sIsNotNull)j.label=j.value="";else{var p=g.val();switch(j.label=p,this._type){case c.text:j.value=p.toLocaleLowerCase();break;case c.date:case c.datetime:j.value=a(p);break;default:j.value=p}o==e.sBetween&&(p=g.next().next().val(),j.label2=p,this._type===c.date||this._type===c.datetime?(j.value2=a(p),j.label2=p):j.value2=p)}}return h},_hiddenValue:function(a,c){var d=b.hidden,e=a.value.value2,f=d("fld-"+c,a.field.value)+d("op-"+c,a.operator.value)+d("val-"+c,a.value.value);return e&&(f+=d("val2-"+c,e)),f},_setHiddenValues:function(){for(var a=this.val(),c=a.length,d=b.hidden("elem",c),e=0;e<c;e++)d+=this._hiddenValue(a[e],e+1);this._hValues.html(d)},_triggerChange:function(){this.submitReady&&this._setHiddenValues(),this.$el.trigger("change.filter")},val:function(a){if(_.isUndefined(a)){var b=[];return this._filters.find("a").each(function(){b.push($(this).data("filter"))}),b}this._filters.empty();for(var c=0,d=a.length;c<d;c++)this.addCondition(a[c]);return this._triggerChange(),this},valText:function(){var a=[];return this._filters.find("a").each(function(){a.push(this.text)}),a.join(" "+d.opAnd+" ")},clear:function(){return this._cFilter=null,this._removeEditor(),this._filters.empty(),this._triggerChange(),this},length:function(){return this._filters.children().length},click_new:function(a){this._step<1&&(this._setEditorField(),this._step=1),this._bAdd.find(".ui-button-text").html(d.bAddCond)},click_add:function(a){var b=this._getEditorData();this._cFilter?this._enableCond(b,this.highlight):this.addCondition(b),this._removeEditor()},click_remove:function(a){a.stopImmediatePropagation(),a.stopPropagation(),$(a.currentTarget).closest("a").remove(),this._triggerChange()},click_submit:function(a){this.$el.trigger("submit.filter")},click_close:function(a){this.$el.trigger("close.filter"),this.clear()}})}(),Evol.ViewAction.Import=function(){var a=Evol.DOM,b=Evol.Dico,c=(Evol.Def.fieldTypes,a.input,Evol.i18n),d=c.export,e=c.import;return Backbone.View.extend({viewName:"import",cardinality:"n",icon:"cloud-upload",events:{"click button":"click_button","change #iptFormat":"change_format","click .ipt-ssample":"toggle_sample"},options:{noDups:!1},initialize:function(a){return _.extend(this,this.options,a),this},render:function(){return this.format="csv",this.$el.html(this._renderHTML()),this},_renderHTML:function(){var b=a.panelBegin({id:"",type:"panel",label:this.getTitle(),width:100},"evol-xpt "+this.style,!1)+'<div class="evol-fset"><div class="evol-fld w-100"><label class="lbl-block">'+e.format+"</label>"+a.input.lov("iptFormat","value","",[{id:"csv",text:d.formatCSV},{id:"json",text:d.formatJSON}])+'<a href="javascript:void(0);" class="ipt-ssample">CSV '+e.fSample+"</a>"+a.html.clearer+'</div><div class="evol-ipt-fh"><textarea class="evol-ipt-format help-block" style="resize:none;"></textarea></div><div class="evol-fld w-100"><label style="margin-top:10px;">'+e.data+'</label><textarea class="evol-xpt-val form-control" id="import_data" rows="12"></textarea></div></div>'+a.panelEnd()+'<div class="panel '+this.style+' evol-buttons form-actions">'+a.button("cancel",c.tools.bCancel,"btn-default")+a.button("import",e.importMany.replace("{0}",this.uiModel.namePlural),"btn btn-primary")+"</div>";return b},importData:function(a,b,c){var d,e=c&&c.noDuplicates;if(b){if(Evol.Config.localStorage){var f=new Backbone.LocalStorage("evol-"+a);d=Backbone.Model.extend({localStorage:f}),Ms=Backbone.Collection.extend({model:d,localStorage:f})}else d=new Backbone.Model({urlRoot:Evol.Config.url+a}),Ms=Backbone.Collection.extend({model:d,url:Evol.Config.url+a});var g=new Ms,h=0,i=0;return g.fetch({success:function(a){_.each(b,function(b){e||delete b.id,a.create(b,{success:function(a){h++},error:function(a){i++}})})},error:function(a,b){alert("Error"+a+b)}}),{total:b.length,inserts:h,errors:i}}return{total:0,inserts:0,errors:0}},setModel:function(a){this.model=a},getTitle:function(){return c.getLabel("import.importMany",this.uiModel.namePlural)},setTitle:function(){b.setViewTitle(this)},val:function(a){return this.$("#import_data").val()},click_button:function(a){var b=$(a.currentTarget).data("id");if("import"===b){var c;if("csv"===this.format){c=Papa.parse(this.val());var d=c.data[0],e=[];_.forEach(c.data,function(a,b){var c={};b>0&&(_.forEach(a,function(a,b){c[d[b]]=a}),e.push(c))}),c=e}else{try{c=JSON.parse(this.val())}catch(a){alert("Invalid JSON.")}_.isArray(c)||(c=[c])}c&&this.$el.trigger("action",{id:b,data:this.importData(this.uiModel.id,c)})}},change_format:function(a){var b=$(a.currentTarget).val();this.format=b,this.$(".evol-ipt-format").val(this.makeSample(b)),this.$(".ipt-ssample").html(b.toUpperCase()+" "+e.fSample),this.sampled=!0},makeSample:function(a){function b(a){var b={};return _.forEach(c,function(c){b[c.attribute]=Evol.Def.sampleDatum(c,a)}),b}var c=this.getFields(),d=[b(0),b(1)],e="";if("json"===a)e=JSON.stringify(d,null,"\t");else{var f=[];for(var g in d[0])f.push(g);e+=f.join(","),_.each(d,function(a){var b=[];_.each(f,function(c){b.push(a[c])}),e+="\n"+b.join(",")})}return e},toggle_sample:function(a){var b=($(a.currentTarget),this.$(".evol-ipt-fh"));this.sampleShown?b.css("height",0):(this.sampled||this.$(".evol-ipt-format").val(this.makeSample("csv")),this.sampled=!0,b.css("height","180px")),this.sampleShown=!this.sampleShown},getFields:function(){return this._fields||(this._fields=Evol.Def.getFields(this.uiModel)),this._fields}})}(),Evol.viewClasses={getClass:function(a){return this[a]?this[a]:this.list}},_.forEach(["browse","edit","mini","json"],function(a){Evol.viewClasses[a]=Evol.ViewOne["json"===a?"JSON":Evol.Format.capitalize(a)]}),_.forEach(["list","cards","bubbles","charts"],function(a){Evol.viewClasses[a]=Evol.ViewMany[Evol.Format.capitalize(a)]}),_.forEach(["filter","export","import"],function(a){Evol.viewClasses[a]=Evol.ViewAction[Evol.Format.capitalize(a)]}),toastr&&(toastr.options={hideDuration:0,closeButton:!0,progressBar:!0}),Evol.Toolbar=function(){var a=Evol.DOM,b=Evol.i18n,c=b.tools;return Backbone.View.extend({events:{"click .nav a":"click_toolbar","navigate.many >div":"click_navigate","paginate.many >div":"paginate","click .evo-search>.btn":"click_search","keyup .evo-search>input":"key_search","click .evo-search>.clear-icon":"clear_search","change.tab >div":"change_tab","action >div":"click_action","status >div":"status_update","change.filter >div":"change_filter","close.filter >div":"hideFilter","click .alert-dismissable>button":"clearMessage","message >div":"showMessage"},options:{toolbar:!0,readonly:!1,defaultView:"list",defaultViewOne:"browse",defaultViewMany:"list",style:"panel-info",display:"label",titleSelector:"#title",pageSize:20,buttons:{always:[{id:"list",label:c.bList,icon:"th-list",n:"x"},{id:"charts",label:c.bCharts,icon:"stats",n:"x"},{id:"new",label:c.bNew,icon:"plus",n:"x",readonly:!1}],actions:[{id:"edit",label:c.bEdit,icon:"edit",n:"1",readonly:!1},{id:"save",label:c.bSave,icon:"floppy-disk",n:"1",readonly:!1},{id:"del",label:c.bDelete,icon:"trash",n:"1",readonly:!1},{id:"filter",label:c.bFilter,icon:"filter",n:"n"},{id:"export",label:c.bExport,icon:"cloud-download",n:"n"}],moreActions:[],prevNext:[{id:"prev",label:c.prev,icon:"chevron-left",n:"x"},{id:"next",label:c.next,icon:"chevron-right",n:"x"}],views:[{id:"browse",label:c.bBrowse,icon:"eye-open",n:"1"},{id:"edit",label:c.bEdit,icon:"edit",n:"1",readonly:!1},{id:"mini",label:c.bMini,icon:"th-large",n:"1",readonly:!1},{id:"json",label:c.bJSON,icon:"barcode",n:"1",readonly:!1},{id:"list",label:c.bList,icon:"th-list",n:"n"},{id:"cards",label:c.bCards,icon:"th-large",n:"n"},{id:"bubbles",label:c.bBubbles,icon:"adjust",n:"n"}],search:!0}},initialize:function(a){_.extend(this,this.options,a),this.views=[],this.viewsHash={}},render:function(){return this.$el.html(this._toolbarHTML()),this.setView(this.defaultViewMany,!1),this.$(".dropdown-toggle").dropdown(),this},_toolbarHTML:function(){function b(a,b){return g.hItem(a.id,b?"":"New"==a.label?"New "+f:a.label,a.icon,a.n)}function c(a,c){return _.map(a,function(a){return e&&a.readonly===!1?null:b(a,c)}).join("")}var d,e=this.readonly!==!1,f=this.uiModel.name||"item",g=a.menu,h=this.buttons,i='<li class="divider" data-cardi="x"></li>',j='<li class="divider-h"></li>';return d='<div class="evo-toolbar"><ul class="nav nav-pills pull-left" data-id="main">'+c(h.always)+j,d+=c(h.actions),h.moreActions&&h.moreActions.length&&(d+=g.hBegin("more","li","menu-hamburger","","n"),_.each(h.moreActions,function(a){d+="-"===a.id?i:b(a)}),d+=g.hEnd("li")),h.search&&(d+=i,d+='<li><div class="input-group evo-search"><input class="evo-field form-control" type="text" maxlength="100" required><div class="clear-icon glyphicon glyphicon-remove"></div><span class="btn input-group-addon glyphicon glyphicon-search"></span></div></li>'),this.toolbar&&(d+='</ul><ul class="nav nav-pills pull-right" data-id="views">',d+='<li class="evo-tb-status" data-cardi="n"></li>',d+=c(h.prevNext),d+=j+c(h.views,!1)),d+="</ul>"+a.html.clearer+"</div>"},refresh:function(){return this.curView&&this.curView.cardinality&&"n"===this.curView.cardinality&&this.curView.render(),this},clearViews:function(a){$("[data-vid=evolw-*]").remove()},isDirty:function(){return!!(this.curView&&this.curView.isDirty&&this.curView.isDirty())},_setView:function(a,b,c){var d,e=this.$el,f="evolw-"+a,g=this.$('[data-vid="'+f+'"]'),h=this.curView,i=this._curCollec();if("new"===a)a=this._prevViewOne&&"browse"!=this._prevViewOne&&"json"!=this._prevViewOne?this._prevViewOne:"edit",this.setView(a,!1,!0),this.model=new this.modelClass,this.model.collection=i,h.model=this.model,this.newItem(),this.setIcons("new"),h.mode="new",this.hideFilter();else{var j=Evol.viewClasses.getClass(a);if(g.length)this.model=h.model,h.model&&(this.model.collection=i),h=this.viewsHash[a],h&&h.setCollection&&h.setCollection(i),this.model&&!this.model.isNew()?(h.setModel?(h.collection||(h.collection=this.model.collection),h.setModel(this.model)):h.model=this.model,h.setTitle&&h.setTitle(),this._tabId&&h.getTab&&this._tabId!=h.getTab()&&h.setTab(this._tabId),"n"===h.cardinality&&h.setPage&&this.pageIndex&&h.setPage(this.pageIndex)):h.clear&&h.clear(),this.$('[data-id="views"] > li').removeClass("evo-sel").filter('[data-id="'+a+'"]').addClass("evo-sel"),this.curView=h,this._keepTab(a),g.show().siblings().not(".evo-toolbar,.evo-filters,.clearfix").hide();else{if(g=$('<div data-vid="evolw-'+a+'"></div>'),e.children().not(".evo-toolbar,.evo-filters,.clearfix").hide(),e.append(g),d={el:g,mode:a,model:this.model,collection:i,uiModel:this.uiModel,style:this.style,pageSize:this.pageSize||20,pageIndex:this.pageIndex||0,titleSelector:this.titleSelector,router:this.router},this.$('[data-id="new"]').show(),this.$('[data-id="views"] > li').removeClass("evo-sel").filter('[data-id="'+a+'"]').addClass("evo-sel"),Evol.Def.isViewMany(a))h=new j(d).render(),this._prevViewMany=a,h.setTitle(),"charts"!=a&&"bubbles"!=a&&this.pageIndex>0&&h.setPage(this.pageIndex||0);else switch(a){case"export":d.sampleMaxSize=d.pageSize,h=new j(d).render();break;case"import":d={el:g,mode:a,uiModel:this.uiModel,collection:this.collection,style:this.style,titleSelector:this.titleSelector,router:this.router},h=new j(d).render();break;default:var k,l=null;h&&h.editable&&(l=h,k=h.getData()),h=new j(d).render(),this._prevViewOne=a,this._keepTab(a)}_.isUndefined(h)?alert("error: invalid route (for toolbar)."):(this.curView=h,this.viewsHash[a]=h,c||this.setTitle())}}this.updateStatus(),"n"===h.cardinality?(this.setRoute("",!1),!this._filterOn&&this._filterValue&&this.showFilter(!1),this.updateNav()):(this.hideFilter(),b&&this.setRoute(this.model?this.model.id:null,!1),this.hideFilter(),this._enableNav()),c||this.setIcons(a)},setView:function(a,b,c){var d=this;return this.proceedIfReady(function(){d._setView(a,b,c)}),this},getView:function(){return this.curView},proceedIfReady:function(b,d){var e,f,g=this,h=h;return this.isDirty()?(e=h.unSavedChanges.replace("{0}",this.curView.getTitle())+"<br><br>"+h.warnNoSave,f={nosave:b,ok:function(){0===g.curView.validate().length&&(g.saveItem(!1,!0),b())}},d&&(f.cancel=d),a.modal.confirm("isDirty",h.unSavedTitle,e,f,[{id:"nosave",text:c.bNoSave,class:"btn-default"},{id:"cancel",text:c.bCancel,class:"btn-default"},{id:"ok",text:c.bSave,class:"btn-primary"}])):b(),this},_keepTab:function(a){!this.tabId||"browse"!=a&&"edit"!=a||this.curView.setTab(this.tabId)},getToolbarButtons:function(){if(!this._toolbarButtons){var a=this.$(".evo-toolbar"),b=a.find(">ul>li"),c=a.find('[data-id="views"]');this._toolbarButtons={ones:b.filter('li[data-cardi="1"]'),manys:b.filter('li[data-cardi="n"]'),edit:b.filter('[data-id="main"]>[data-id="edit"]'),del:b.filter('[data-id="del"]'),save:b.filter('[data-id="save"]'),prevNext:b.filter('[data-id="prev"],[data-id="next"]'),more:b.filter('[data-id="more"]'),views:c,viewsIcon:this.$(".glyphicon-eye-open,.glyphicon-eye-close"),vws:c.find("ul>li>a")}}return this._toolbarButtons},setIcons:function(b){function c(a,b,c){d(f.ones,b),d(f.manys,c),f.vws.removeAttr("style"),f.views.find('[data-id="'+a+'"]>a').css("color","#428bca")}var d=a.showOrHide,e="export"===b||"import"===b;if(this.$el){var f=this.getToolbarButtons();if(f.prevNext.hide(),d(f.views,!(e||"new"==b)),f.del.hide(),Evol.Def.isViewMany(b)){if(this._prevViewMany=b,c(b,!1,!0),"charts"!==b&&"bubbles"!==b){var g=this.collection.length,h=this.curView.pageSize;g>h&&f.prevNext.show()}}else this.model&&this.model.isNew()||"new"===b||e?(c(b,!1,!1),f.del.hide(),f.views.hide(),d(f.more,e),d(f.save,!e)):(this._prevViewOne=b,c(b,!0,!1),f.prevNext.show(),d(f.save,"browse"!==b),d(f.edit,"browse"===b))}},showFilter:function(b){if(this._filters)this._filters.$el.show();else if(b){var c=this,d=$(a.panelEmpty("filters","evo-filters","info"));
this.$(".evo-toolbar").after(d),this._filters=new Evol.ViewAction.Filter({el:d,uiModel:this.uiModel}).render(),d.on("change.filter",function(){c.curView.setFilter(c._filters.val()),"bubbles"!==c.curView.viewName&&c.curView.render()})}return this._filterOn=!0,this},hideFilter:function(){return this._filters&&this._filters.$el.hide(),this._filterOn=!1,this},toggleFilter:function(a){return this._filterOn=_.isBoolean(a)?a:!this._filterOn,this._filterOn?this.showFilter(!0):this.hideFilter()},_flagFilterIcon:function(b){a.addRemClass(this.$('a[data-id="filter"]'),b,"evo-filter-on")},setData:function(a){return this.curView&&this.curView.setData(a),this},getData:function(a){return this.curView?this.curView.getData(a):null},getCollection:function(){return this._curCollec()},setModelById:function(b,c){var d,e=this,f=function(){e.model=d,c||("1"!=e.curView.cardinality&&e.setView(e.defaultViewOne),e.curView.setModel(d),a.scroll2Top())},g=function(){alert("Error: Invalid model ID.")};if(Evol.Config.localStorage)d=this.collection.get(b),_.isUndefined(d)?g():f();else{var h=Backbone.Model.extend({urlRoot:Evol.Config.url+e.uiModel.id});d=new h({id:b}),d.fetch({success:f,error:g})}return this},navPrevNext:function(a){var c=this._curCollec(),d=this.curView.model;if(d&&c&&c.length){var e=c.length-1,f=_.indexOf(c.models,d);f="prev"===a?f>0?f-1:e:f<e?f+1:0,d=c.models[f]}else d=null;return this.model=d,this.curView.setModel(d),d?this.setRoute(d?d.id:null,!1):this.setMessage(b.notFound,b.getLabel("notFoundMsg",this.uiModel.name),"error"),this.clearMessage()},setRoute:function(a,b,c){return Evol.Dico.setRoute(this.router,this.uiModel.id,c||this.curView.viewName,a,b),Evol.Dico.setPageTitle(this.curView.getTitle()),this},saveItem:function(a,c){function d(b){a?(e.newItem(),this._trigger("item.added")):(b.unset(""),e.model=b,e._filteredCollection&&e._filteredCollection.add(b),e.setIcons("edit"),f.setModel(b),e._trigger("item.saved",{model:b,uiModel:e.uiModel})),f.setTitle()}var e=this,f=this.curView,g=c?[]:f.validate();if(0===g.length){var h=this.uiModel.name;if(_.isUndefined(this.model)||this.model&&this.model.isNew())this.collection?(this.collection.create(this.getData(!0),{success:function(a){d(a),e.setRoute(a.id,!1),e.setMessage(b.getLabel("saved",Evol.Format.capitalize(h)),b.getLabel("msg.added",h,_.escape(f.getTitle())),"success")},error:function(a,b){alert('Error in "saveItem"')}}),this.mode="edit"):alert("Can't save record b/c no collection is specified.");else{var i=this.getData(!0);this.model.set(i),this.model.save(this.model.changedAttributes(),{success:function(a){d(a),e.collection.set(a,{remove:!1}),e.setMessage(b.getLabel("saved",Evol.Format.capitalize(h)),b.getLabel("msg.updated",Evol.Format.capitalize(h),_.escape(f.getTitle())),"success")},error:function(a,b){alert("Error "+b.status+" - "+b.statusText)}})}}else{var j="<ul><li>"+g.join("</li><li>")+"</li></ul>";this.setMessage(b.validation.incomplete,j,"warning")}return this},newItem:function(){var a=this.curView;return"browse"===a.viewName&&("browse"!==this._prevViewOne&&"json"!==this._prevViewOne?this.setView(this._prevViewOne):this.setView("edit",!1,!0)),this.curView.setDefaults().setTitle(b.getLabel("tools.newEntity",this.uiModel.name,a.getTitle()))},deleteItem:function(c,d,e){var f,g=this,h=(d||this.uiModel.id,this.uiModel.name),i=e&&e.title||this.curView.getTitle();if(d||"1"===this.curView.cardinality){if(d){var j=Evol.Config.localStorage?""+d:d;this.model=this.collection.findWhere({id:j});var k=this.uiModel.fnTitle;k&&this.model&&(i=_.isString(k)?this.model.get(k):k(g.model))}f=function(){var a=g.collection,c=_.indexOf(a.models,l),f=c,j=null;a.length>1&&(f=0===c?1:c<a.length-1?c+1:c-1,j=a.at(f)),j&&(j.collection=a);var k={success:function(){null===j||0===a.length?g.curView.clear&&g.curView.clear():(g.model=j,d||(g.setRoute(j.id,!1),g.curView.setModel(j)));var c=Evol.Format.capitalize(h);g.setMessage(b.getLabel("deleted1",c),b.getLabel("msg.deleted",c,i),"info"),e&&e.fnSuccess&&e.fnSuccess(),g._trigger("item.deleted")},error:function(a,b){alert('error in "deleteItem"')}};d||Evol.Config.localStorage||(k.url=g.model.url()),a.remove(l),l.destroy(k)};var l=this.model;l&&(c?f():a.modal.confirm("delete",b.getLabel("deleteX",h),b.getLabel("delete1",h,_.escape(i)),{ok:f}))}},setMessage:function(a,b,c){return toastr[c||"info"](b,a),this},clearMessage:function(){return this.$('[data-id="msg"]').remove(),toastr.clear(),this},showMessage:function(a,b){return b?this.setMessage(b.title,b.content,b.style):this.clearMessage()},setTitle:function(){return this.curView&&this.curView.setTitle(),this},getStatus:function(){return"n"===this.curView.cardinality?this._filteredCollection?this._filteredCollection.length+" / "+this.collection.length+" "+this.uiModel.namePlural:this.collection.length+" "+this.uiModel.namePlural:""},setStatus:function(a){this.$(".evo-toolbar .evo-tb-status").html(a),this.$(".evo-many-summary").html(a)},updateStatus:function(){this.setStatus(this.getStatus())},click_action:function(a,c){var d;switch(d=_.isString(c)?c:c.id){case"cancel":window.history.back();break;case"edit":c.mid?(this.setModelById(c.mid),this.setRoute(c.mid,!1,"edit")):this.setView(d,!0);break;case"delete":c.mid&&this.deleteItem(c.skipWarning,c.mid,c);break;case"save":case"save-add":this.saveItem("save-add"===d);break;case"import":var e,f,g=c.data;g&&g.total?(f=g.errors.length?g.inserts.length?"warning":"error":"success",e=g.inserts+" "+this.uiModel.name+" added.",g.errors>0&&(e+="<br>"+g.errors.length+" Errors."),this.setMessage(b.import.success,e,f)):this.setMessage(b.import.empty,"","warning")}},paginate:function(a,b){b&&(a=b.id);var c=this.pageIndex||0;if("prev"===a)c=c>0?c-1:0;else if("next"===a)(c+1)*this.pageSize<this.curView.collection.length&&c++;else{var d=parseInt(a,10);d>0&&(c=d-1)}return this.pageIndex=c,this.updateNav(),this.curView.setPage&&this.curView.setPage(c),this},updateNav:function(){var b=this.curView.collection?this.curView.collection.length:0,c="disabled",d=this.pageIndex||0,e=this.$('[data-id="prev"]');a.addRemClass(e,0===d,c),a.addRemClass(e.next(),(d+1)*this.pageSize>b,c)},_enableNav:function(){this.$('[data-id="prev"],[data-id="next"]').removeClass("disabled")},status_update:function(a,b){this.setStatus(b)},_curCollec:function(){return this._filteredCollection?this._filteredCollection:this.collection?this.collection:this.model?this.model.collection:new this.collectionClass},click_toolbar:function(a,b){var c=$(a.currentTarget);"A"!==c.tagName&&(c=c.closest("a"));var d=c.data("id");switch(d){case"save":this.saveItem(!1);break;case"del":this.deleteItem(a.shiftKey);break;case"filter":this.toggleFilter();break;case"prev":case"next":if("1"===this.curView.cardinality){var e=this;this.proceedIfReady(function(){e.navPrevNext(d)})}else"n"===this.curView.cardinality&&this.paginate(d);break;default:d&&""!==d&&this.setView(d,!0),this.updateStatus()}this._trigger("toolbar."+d)},_trigger:function(a,b){this.$el.trigger(a,b)},click_navigate:function(a,b,c){a.stopImmediatePropagation(),this.setModelById(b.id),b.view&&this.setView(b.view),this.setRoute(b.id,!1,b.view)},change_tab:function(a,b){b&&(this._tabId=b.id)},change_filter:function(a){if("filter"===a.namespace){var b,c=this._filters.val();if(c.length){var d=this._searchString?this._filteredCollection.models:this.model.collection.models;d=Evol.Dico.filterModels(d,c),b=this.collectionClass?new this.collectionClass(d):new Backbone.Collection(d),this._filteredCollection=b,this._filterValue=c}else b=this.collection,this._filteredCollection=null,this._filterValue=null;this.updateStatus(),this._flagFilterIcon(c.length),this.pageIndex=0,this.curView.setCollection(b),this.updateNav(),this._trigger("filter.change")}},click_search:function(a){var b,c=this.$(".evo-search>input").val().toLowerCase(),d=Evol.Def.fnSearch(this.uiModel,c);if(this._searchString=c,c){var e=(this.collection||this.model.collection).models.filter(d);b=this.collectionClass?new this.collectionClass(e):new Backbone.Collection(e),this._filteredCollection=b}else b=this.collection,this._filteredCollection=null;this.updateStatus(),this.pageIndex=0,"many"===this.curView.viewType||this.curView.isChart||this.setView("list",!0),this.curView.setCollection(b),this.updateNav(),this._trigger("search")},key_search:function(a){13===a.keyCode&&(a.preventDefault(),this.click_search(a))},clear_search:function(a){var b=this.collection;this._filteredCollection=null,this.updateStatus(),this.pageIndex=0,this.curView.setCollection&&this.curView.setCollection(b),this._searchString=null,this.$(".evo-search>input").val("").focus()},click_selection:function(a,c){var d=(this.$(".evo-toolbar .evo-tb-status"),this.$(".list-sel:checked").not('[data-id="cbxAll"]').length),e=this.getToolbarButtons();d>0?(this.setStatus(b.getLabel("selected",d)),e.del.show()):(this.setStatus(""),e.del.hide())}})}(),Evol.App=Backbone.View.extend({options:{elements:{nav:".evo-head-links",nav2:".evo-head-links2",content:"#evol"},style:"panel-default",useRouter:!0,pageSize:20,prefix:"evol-"},initialize:function(a){_.extend(this,this.options,a);var b={};_.forEach(this.uiModels,function(a,c){b[a.id||"uim"+c]=a}),this.uiModelsObj=b,this._tbs={},this._ents={};var c=this.elements;this.$nav2=$(c.nav2),this.setupRouter()},setupRouter:function(){var a=this,b=Backbone.Router.extend({routes:{"":"nav",":entity(/:view)(/:id)":"nav","*noroute":a.noRoute},nav:function(b,c,d){b&&a.uiModelsObj[b]&&a.setEntity(b,c,d)}});this.router=new b,Backbone.history.start()},setRoute:function(a,b){var c=this._tbs[this._curEntity].curView;return c?(Evol.Dico.setRoute(this.router,c.uiModel.id,c.viewName,a,b),Evol.Dico.setPageTitle(c.getTitle())):alert("Error: Invalid route (for app)."),this},noRoute:function(a){alert('Error: Invalid route "'+a+'".')},setEntity:function(a,b,c){var d=this,e=this._tbs[this._curEntity],f=function(){d._setEntity(a,b,c)},g=function(){e&&e.curView&&d.setRoute(e.curView.model.id,!1)};this._curEntity?e?e.proceedIfReady(f,g):g():f()},_setEntity:function(a,b,c){function d(){e._ents[a].show().siblings().hide();var d=e._tbs[a];d&&(e._curEntity=a,d.curView.viewName!==b&&d.setView(b,!1,!1).setTitle(),c&&("1"===d.curView.cardinality?(d.setModelById(c),e.setRoute(c,!1)):e.setRoute("",!1)))}var e=this;if(b=b||"list",this._ents[a])d();else{var f=$('<div data-eid="'+a+'"></div>');this._ents[a]=f,this.$el.children().hide(),this.$el.append(f),this.createEntity(f,this.uiModelsObj[a],[],b,c,d)}return this._curEntity!==a&&(this.$nav2.find(">li>a").removeClass("sel").filter('[data-id="'+a+'"]').addClass("sel"),this._curEntity=a),this},createEntity:function(a,b,c,d,e,f){var g,h,i,j=this;if(Evol.Config)if(Evol.Config.localStorage){var k=new Backbone.LocalStorage(this.prefix+(b.table||b.id));h=Backbone.Model.extend({localStorage:k}),i=Backbone.Collection.extend({model:h,localStorage:k})}else g=Evol.Config.url+b.id,h=Backbone.Model.extend({urlRoot:g}),i=Backbone.Collection.extend({model:h,url:g});else alert("Error: missing config file.");var l=new i;l.fetch({success:function(c){var g=l.at(0),k={el:a,mode:"list",model:g,modelClass:h,collection:l,collectionClass:i,uiModel:b,pageSize:j.pageSize,titleSelector:"#title",style:j.style};d&&(k.defaultView=d),j.useRouter&&(k.router=j.router);var m=new Evol.Toolbar(k).render();e&&"1"===m.cardinality&&m.setModelById(e),j._tbs&&(j._tbs[b.id]=m),f&&f(m)},error:function(a){alert("Error: invalid route (for app).")}})},_HTMLentities:function(a){return _.map(a,function(a){return'<li><a href="#'+a.id+'/list" data-id="'+a.id+'">'+a.namePlural+"</a></li>"}).join("")}});